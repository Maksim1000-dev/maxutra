<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maxutra - Мессенджер</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .chat-bubble-sent {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px 20px 5px 20px;
        }
        
        .chat-bubble-received {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px 20px 20px 5px;
        }
        
        .sidebar {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
        }
        
        .chat-area {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
        }
        
        .user-online::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: #10b981;
            border-radius: 50%;
            border: 2px solid #1a1a2e;
        }
        
        .user-offline::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: #6b7280;
            border-radius: 50%;
            border: 2px solid #1a1a2e;
        }
        
        .message-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.5);
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .pulse-call {
            animation: pulseCall 1.5s ease-in-out infinite;
        }
        
        @keyframes pulseCall {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(102, 126, 234, 0); }
        }
        
        .typing-indicator span {
            animation: typing 1.4s infinite;
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            margin: 0 2px;
        }
        
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .input-field {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            background: rgba(255, 255, 255, 0.12);
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        
        .chat-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        
        .chat-item.active {
            background: rgba(102, 126, 234, 0.2);
            border-left: 3px solid #667eea;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div id="app">
        <div class="min-h-screen flex items-center justify-center">
            <div class="text-center">
                <div class="w-16 h-16 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-white/70">Загрузка Maxutra...</p>
            </div>
        </div>
    </div>
    <script>
        const API_URL = window.location.origin;
        let currentUser = null;
        let currentChat = null;
        let ws = null;
        let peerConnection = null;
        let localStream = null;
        let currentCall = null;
        let otherUserData = null;
        let typingTimeout = null;
        let callStartTime = null;
        let callTimerInterval = null;
        // Безопасное чтение из localStorage
        function safeGetUser() {
            try {
                const saved = localStorage.getItem('maxutra_user');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (parsed && parsed.id && parsed.username) {
                        return parsed;
                    }
                }
            } catch (e) {
                console.log('Очистка невалидных данных из localStorage');
                localStorage.removeItem('maxutra_user');
            }
            return null;
        }
        // Initialize app
        function init() {
            currentUser = safeGetUser();
            if (currentUser) {
                connectWebSocket();
                renderMainApp();
            } else {
                renderAuth();
            }
        }
        // WebSocket connection
        function connectWebSocket() {
            if (!currentUser) return;
            
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(wsProtocol + '//' + window.location.host);
            
            ws.onopen = function() {
                console.log('WebSocket подключен');
                ws.send(JSON.stringify({ type: 'auth', userId: currentUser.id }));
            };
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (e) {
                    console.error('Ошибка парсинга WebSocket сообщения:', e);
                }
            };
            
            ws.onclose = function() {
                console.log('WebSocket отключен, переподключение...');
                setTimeout(function() {
                    if (currentUser) connectWebSocket();
                }, 3000);
            };
            
            ws.onerror = function(e) {
                console.error('WebSocket ошибка:', e);
            };
        }
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'new_message':
                    if (currentChat && data.message.chatId === currentChat.id) {
                        appendMessage(data.message);
                    }
                    loadChats();
                    break;
                case 'incoming_call':
                    showIncomingCall(data);
                    break;
                case 'call_accepted':
                    startWebRTCConnection(true);
                    break;
                case 'call_ended':
                    endCall();
                    break;
                case 'webrtc_offer':
                    handleWebRTCOffer(data);
                    break;
                case 'webrtc_answer':
                    handleWebRTCAnswer(data);
                    break;
                case 'webrtc_ice':
                    handleICECandidate(data);
                    break;
                case 'user_typing':
                    showTypingIndicator(data);
                    break;
            }
        }
        // Auth screens
        function renderAuth() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen gradient-bg flex items-center justify-center p-4">
                    <div class="glass rounded-3xl p-8 w-full max-w-md fade-in">
                        <div class="text-center mb-8">
                            <div class="w-20 h-20 mx-auto mb-4 rounded-2xl bg-white/20 flex items-center justify-center">
                                <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
                                </svg>
                            </div>
                            <h1 class="text-4xl font-bold mb-2">
                                <span class="bg-clip-text text-transparent bg-gradient-to-r from-white to-purple-200">Maxutra</span>
                            </h1>
                            <p class="text-white/70">Безопасный мессенджер</p>
                        </div>
                        
                        <div id="authForm">
                            <div id="loginForm">
                                <input type="text" id="loginUsername" placeholder="Имя пользователя" 
                                    class="input-field w-full rounded-xl px-4 py-3 mb-4 outline-none text-white placeholder-white/50">
                                <input type="password" id="loginPassword" placeholder="Пароль" 
                                    class="input-field w-full rounded-xl px-4 py-3 mb-6 outline-none text-white placeholder-white/50">
                                <button onclick="login()" 
                                    class="btn-primary w-full rounded-xl py-3 font-semibold text-white">
                                    Войти
                                </button>
                                <div class="flex justify-between mt-6 text-sm">
                                    <button onclick="showRegister()" class="text-purple-200 hover:text-white transition">Регистрация</button>
                                    <button onclick="showForgotPassword()" class="text-purple-200 hover:text-white transition">Забыли пароль?</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="errorMessage" class="mt-4 p-3 bg-red-500/20 border border-red-500/50 rounded-xl text-red-300 text-center hidden"></div>
                    </div>
                </div>
            `;
        }
        function showRegister() {
            document.getElementById('authForm').innerHTML = `
                <div id="registerForm" class="fade-in">
                    <input type="text" id="regDisplayName" placeholder="Ваше имя (отображается другим)" 
                        class="input-field w-full rounded-xl px-4 py-3 mb-4 outline-none text-white placeholder-white/50">
                    <input type="text" id="regUsername" placeholder="Логин (для входа)" 
                        class="input-field w-full rounded-xl px-4 py-3 mb-4 outline-none text-white placeholder-white/50">
                    <input type="password" id="regPassword" placeholder="Пароль" 
                        class="input-field w-full rounded-xl px-4 py-3 mb-4 outline-none text-white placeholder-white/50">
                    <input type="text" id="regSecretCode" placeholder="Секретный код (для восстановления)" 
                        class="input-field w-full rounded-xl px-4 py-3 mb-3 outline-none text-white placeholder-white/50">
                    <p class="text-xs text-white/50 mb-6 text-center">Запомните секретный код — он нужен для восстановления пароля</p>
                    <button onclick="register()" 
                        class="btn-primary w-full rounded-xl py-3 font-semibold text-white">
                        Создать аккаунт
                    </button>
                    <button onclick="renderAuth()" class="w-full mt-4 py-2 text-purple-200 hover:text-white transition">
                        ← Уже есть аккаунт
                    </button>
                </div>
            `;
        }
        function showForgotPassword() {
            document.getElementById('authForm').innerHTML = `
                <div id="forgotForm" class="fade-in">
                    <h3 class="text-lg font-semibold mb-6 text-center">Восстановление пароля</h3>
                    <input type="text" id="forgotUsername" placeholder="Ваш логин" 
                        class="input-field w-full rounded-xl px-4 py-3 mb-4 outline-none text-white placeholder-white/50">
                    <input type="text" id="forgotSecretCode" placeholder="Секретный код" 
                        class="input-field w-full rounded-xl px-4 py-3 mb-4 outline-none text-white placeholder-white/50">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="flex-1 h-px bg-white/20"></div>
                        <span class="text-white/50 text-sm">или</span>
                        <div class="flex-1 h-px bg-white/20"></div>
                    </div>
                    <input type="email" id="forgotEmail" placeholder="Email (если указывали)" 
                        class="input-field w-full rounded-xl px-4 py-3 mb-6 outline-none text-white placeholder-white/50">
                    <button onclick="forgotPassword()" 
                        class="btn-primary w-full rounded-xl py-3 font-semibold text-white">
                        Восстановить
                    </button>
                    <button onclick="renderAuth()" class="w-full mt-4 py-2 text-purple-200 hover:text-white transition">
                        ← Назад к входу
                    </button>
                    <div id="recoveredPassword" class="mt-6 p-4 bg-green-500/20 border border-green-500/50 rounded-xl hidden">
                        <p class="text-green-300 text-center">Ваш пароль: <span id="passwordDisplay" class="font-bold text-white"></span></p>
                    </div>
                </div>
            `;
        }
        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showError('Заполните все поля');
                return;
            }
            
            try {
                const res = await fetch(API_URL + '/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: username, password: password })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('maxutra_user', JSON.stringify(currentUser));
                    connectWebSocket();
                    renderMainApp();
                } else {
                    showError(data.error || 'Ошибка входа');
                }
            } catch (e) {
                console.error('Login error:', e);
                showError('Ошибка подключения к серверу');
            }
        }
        async function register() {
            const displayName = document.getElementById('regDisplayName').value.trim();
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;
            const secretCode = document.getElementById('regSecretCode').value.trim();
            
            if (!displayName || !username || !password || !secretCode) {
                showError('Заполните все поля');
                return;
            }
            
            try {
                const res = await fetch(API_URL + '/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: username, 
                        password: password, 
                        secretCode: secretCode, 
                        displayName: displayName 
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('maxutra_user', JSON.stringify(currentUser));
                    connectWebSocket();
                    renderMainApp();
                } else {
                    showError(data.error || 'Ошибка регистрации');
                }
            } catch (e) {
                console.error('Register error:', e);
                showError('Ошибка подключения к серверу');
            }
        }
        async function forgotPassword() {
            const username = document.getElementById('forgotUsername').value.trim();
            const secretCode = document.getElementById('forgotSecretCode').value.trim();
            const email = document.getElementById('forgotEmail').value.trim();
            
            if (!username) {
                showError('Введите логин');
                return;
            }
            
            if (!secretCode && !email) {
                showError('Введите секретный код или email');
                return;
            }
            
            try {
                const res = await fetch(API_URL + '/api/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: username, secretCode: secretCode, email: email })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    document.getElementById('recoveredPassword').classList.remove('hidden');
                    document.getElementById('passwordDisplay').textContent = data.password;
                } else {
                    showError(data.error || 'Не удалось восстановить пароль');
                }
            } catch (e) {
                console.error('Forgot password error:', e);
                showError('Ошибка подключения к серверу');
            }
        }
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
                setTimeout(function() { 
                    errorEl.classList.add('hidden'); 
                }, 4000);
            }
        }
        // Main App
        function renderMainApp() {
            document.getElementById('app').innerHTML = `
                <div class="flex h-screen">
                    <!-- Sidebar -->
                    <div class="sidebar w-80 flex flex-col border-r border-white/10">
                        <!-- Header -->
                        <div class="p-4 border-b border-white/10">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center font-bold">
                                        ${currentUser.displayName ? currentUser.displayName.charAt(0).toUpperCase() : 'U'}
                                    </div>
                                    <div>
                                        <h1 class="font-bold text-lg bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-400">Maxutra</h1>
                                        <p class="text-xs text-white/50">${currentUser.displayName || currentUser.username}</p>
                                    </div>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="showSettings()" class="p-2 hover:bg-white/10 rounded-lg transition" title="Настройки">
                                        <svg class="w-5 h-5 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                    </button>
                                    <button onclick="logout()" class="p-2 hover:bg-white/10 rounded-lg transition" title="Выйти">
                                        <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Search -->
                            <div class="relative">
                                <input type="text" id="searchInput" placeholder="Поиск людей..." 
                                    oninput="searchUsers()"
                                    class="input-field w-full rounded-xl px-4 py-2.5 pl-10 outline-none text-white placeholder-white/50 text-sm">
                                <svg class="w-4 h-4 absolute left-3.5 top-3 text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <div id="searchResults" class="mt-2 max-h-60 overflow-y-auto hidden bg-gray-800/90 rounded-xl"></div>
                        </div>
                        
                        <!-- Chats list -->
                        <div class="flex-1 overflow-y-auto scrollbar-thin" id="chatsList">
                            <div class="p-8 text-center text-white/50">
                                <div class="w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
                                <p>Загрузка чатов...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chat area -->
                    <div class="flex-1 chat-area flex flex-col" id="chatArea">
                        <div class="flex-1 flex items-center justify-center text-white/50">
                            <div class="text-center p-8">
                                <div class="w-24 h-24 mx-auto mb-6 rounded-3xl bg-white/5 flex items-center justify-center">
                                    <svg class="w-12 h-12 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-xl font-semibold text-white/70 mb-2">Выберите чат</h3>
                                <p class="text-sm">или найдите собеседника через поиск</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Modals container -->
                <div id="modals"></div>
            `;
            
            loadChats();
        }
        async function loadChats() {
            try {
                const res = await fetch(API_URL + '/api/chats/' + currentUser.id);
                const chats = await res.json();
                
                const chatsList = document.getElementById('chatsList');
                if (!chatsList) return;
                
                if (chats.length === 0) {
                    chatsList.innerHTML = `
                        <div class="p-8 text-center text-white/50">
                            <svg class="w-16 h-16 mx-auto mb-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                            <p class="font-medium mb-1">У вас пока нет чатов</p>
                            <p class="text-sm">Найдите собеседника через поиск выше</p>
                        </div>
                    `;
                    return;
                }
                
                chatsList.innerHTML = chats.map(function(chat) {
                    var isActive = currentChat && currentChat.id === chat.id;
                    var otherUser = chat.otherUser || {};
                    var initial = otherUser.displayName ? otherUser.displayName.charAt(0).toUpperCase() : '?';
                    var statusClass = otherUser.status === 'online' ? 'user-online' : 'user-offline';
                    var lastMsg = chat.lastMessage ? chat.lastMessage.content : 'Нет сообщений';
                    var lastTime = chat.lastMessage ? formatTime(chat.lastMessage.timestamp) : '';
                    
                    return '<div onclick="openChat(\'' + chat.id + '\', \'' + otherUser.id + '\')" class="chat-item p-4 cursor-pointer transition border-b border-white/5 ' + (isActive ? 'active' : '') + '">' +
                        '<div class="flex items-center gap-3">' +
                            '<div class="relative ' + statusClass + '">' +
                                '<div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-lg font-semibold">' + initial + '</div>' +
                            '</div>' +
                            '<div class="flex-1 min-w-0">' +
                                '<div class="flex justify-between items-center">' +
                                    '<h3 class="font-semibold truncate">' + (otherUser.displayName || 'Неизвестный') + '</h3>' +
                                    '<span class="text-xs text-white/30 ml-2">' + lastTime + '</span>' +
                                '</div>' +
                                '<p class="text-sm text-white/50 truncate">' + escapeHtml(lastMsg) + '</p>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                }).join('');
            } catch (e) {
                console.error('Error loading chats:', e);
            }
        }
        async function searchUsers() {
            var query = document.getElementById('searchInput').value.trim();
            var resultsEl = document.getElementById('searchResults');
            
            if (query.length < 2) {
                resultsEl.classList.add('hidden');
                return;
            }
            
            try {
                var res = await fetch(API_URL + '/api/users/search?query=' + encodeURIComponent(query) + '&currentUserId=' + currentUser.id);
                var users = await res.json();
                
                if (users.length === 0) {
                    resultsEl.innerHTML = '<div class="p-4 text-white/50 text-sm text-center">Пользователи не найдены</div>';
                } else {
                    resultsEl.innerHTML = users.map(function(user) {
                        var initial = user.displayName.charAt(0).toUpperCase();
                        var statusClass = user.status === 'online' ? 'user-online' : 'user-offline';
                        return '<div onclick="startChatWith(\'' + user.id + '\')" class="p-3 hover:bg-white/10 cursor-pointer transition flex items-center gap-3">' +
                            '<div class="relative ' + statusClass + '">' +
                                '<div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center font-semibold">' + initial + '</div>' +
                            '</div>' +
                            '<div class="flex-1">' +
                                '<p class="font-medium">' + escapeHtml(user.displayName) + '</p>' +
                                '<p class="text-xs text-white/50">@' + escapeHtml(user.username) + '</p>' +
                            '</div>' +
                        '</div>';
                    }).join('');
                }
                
                resultsEl.classList.remove('hidden');
            } catch (e) {
                console.error('Error searching users:', e);
            }
        }
        async function startChatWith(userId) {
            try {
                var res = await fetch(API_URL + '/api/chats', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId1: currentUser.id, userId2: userId })
                });
                
                var chat = await res.json();
                document.getElementById('searchInput').value = '';
                document.getElementById('searchResults').classList.add('hidden');
                await loadChats();
                openChat(chat.id, userId);
            } catch (e) {
                console.error('Error starting chat:', e);
            }
        }
        async function openChat(chatId, otherUserId) {
            currentChat = { id: chatId, otherUserId: otherUserId };
            
            try {
                // Get other user info
                var usersRes = await fetch(API_URL + '/api/users?currentUserId=' + currentUser.id);
                var users = await usersRes.json();
                otherUserData = users.find(function(u) { return u.id === otherUserId; }) || {};
                
                // Get messages
                var messagesRes = await fetch(API_URL + '/api/messages/' + chatId);
                var messages = await messagesRes.json();
                
                var initial = otherUserData.displayName ? otherUserData.displayName.charAt(0).toUpperCase() : '?';
                var statusClass = otherUserData.status === 'online' ? 'user-online' : 'user-offline';
                var statusText = otherUserData.status === 'online' ? 'В сети' : 'Не в сети';
                
                var messagesHtml = messages.length === 0 
                    ? '<div class="text-center text-white/50 mt-10"><p>Начните общение!</p><p class="text-sm mt-1">Напишите первое сообщение</p></div>'
                    : messages.map(function(m) { return renderMessage(m); }).join('');
                
                document.getElementById('chatArea').innerHTML = `
                    <!-- Chat header -->
                    <div class="p-4 border-b border-white/10 flex items-center justify-between bg-black/20">
                        <div class="flex items-center gap-3">
                            <div class="relative ${statusClass}">
                                <div class="w-11 h-11 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center font-semibold text-lg">${initial}</div>
                            </div>
                            <div>
                                <h3 class="font-semibold">${escapeHtml(otherUserData.displayName || 'Неизвестный')}</h3>
                                <p class="text-xs text-white/50">${statusText}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="startCall('audio')" class="p-3 hover:bg-white/10 rounded-xl transition" title="Аудиозвонок">
                                <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                </svg>
                            </button>
                            <button onclick="startCall('video')" class="p-3 hover:bg-white/10 rounded-xl transition" title="Видеозвонок">
                                <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Messages -->
                    <div class="flex-1 overflow-y-auto p-4 scrollbar-thin" id="messagesContainer">
                        ${messagesHtml}
                    </div>
                    
                    <!-- Typing indicator -->
                    <div id="typingIndicator" class="px-4 py-2 hidden">
                        <div class="typing-indicator flex items-center gap-1 text-white/50 text-sm">
                            <span></span><span></span><span></span>
                            <span class="ml-2">${escapeHtml(otherUserData.displayName || 'Собеседник')} печатает...</span>
                        </div>
                    </div>
                    
                    <!-- Input -->
                    <div class="p-4 border-t border-white/10 bg-black/20">
                        <div class="flex gap-3">
                            <input type="text" id="messageInput" placeholder="Написать сообщение..." 
                                onkeydown="handleMessageKeydown(event)"
                                oninput="sendTyping()"
                                class="message-input flex-1 bg-white/10 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-white/50">
                            <button onclick="sendMessage()" 
                                class="btn-primary px-5 rounded-xl flex items-center justify-center">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                
                scrollToBottom();
                loadChats();
            } catch (e) {
                console.error('Error opening chat:', e);
            }
        }
        function renderMessage(message) {
            var isSent = message.senderId === currentUser.id;
            var bubbleClass = isSent ? 'chat-bubble-sent' : 'chat-bubble-received';
            var alignClass = isSent ? 'justify-end' : 'justify-start';
            var timeClass = isSent ? 'text-white/60' : 'text-white/40';
            
            return '<div class="flex ' + alignClass + ' mb-3 slide-in">' +
                '<div class="' + bubbleClass + ' px-4 py-2.5 max-w-[70%] shadow-lg">' +
                    '<p class="break-words">' + escapeHtml(message.content) + '</p>' +
                    '<p class="text-xs ' + timeClass + ' mt-1">' + formatTime(message.timestamp) + '</p>' +
                '</div>' +
            '</div>';
        }
        function appendMessage(message) {
            var container = document.getElementById('messagesContainer');
            if (container) {
                var emptyMsg = container.querySelector('.text-center');
                if (emptyMsg) {
                    container.innerHTML = '';
                }
                container.insertAdjacentHTML('beforeend', renderMessage(message));
                scrollToBottom();
            }
        }
        function scrollToBottom() {
            var container = document.getElementById('messagesContainer');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }
        async function sendMessage() {
            var input = document.getElementById('messageInput');
            var content = input.value.trim();
            
            if (!content || !currentChat) return;
            
            try {
                await fetch(API_URL + '/api/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chatId: currentChat.id,
                        senderId: currentUser.id,
                        content: content
                    })
                });
                
                input.value = '';
            } catch (e) {
                console.error('Error sending message:', e);
            }
        }
        function handleMessageKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
        function sendTyping() {
            if (ws && ws.readyState === 1 && currentChat) {
                ws.send(JSON.stringify({
                    type: 'typing',
                    chatId: currentChat.id,
                    userId: currentUser.id
                }));
            }
        }
        function showTypingIndicator(data) {
            if (currentChat && data.chatId === currentChat.id && data.userId !== currentUser.id) {
                var indicator = document.getElementById('typingIndicator');
                if (indicator) {
                    indicator.classList.remove('hidden');
                    clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(function() {
                        indicator.classList.add('hidden');
                    }, 2000);
                }
            }
        }
        // Calls
        function startCall(type) {
            if (!currentChat || !otherUserData) return;
            
            var callId = Date.now().toString();
            currentCall = { id: callId, type: type, isInitiator: true };
            
            ws.send(JSON.stringify({
                type: 'call_request',
                callId: callId,
                callerId: currentUser.id,
                receiverId: currentChat.otherUserId,
                callerName: currentUser.displayName || currentUser.username,
                callType: type
            }));
            
            showCallUI(type, otherUserData.displayName || 'Собеседник', true);
        }
        function showIncomingCall(data) {
            currentCall = { id: data.callId, type: data.callType, isInitiator: false, callerId: data.callerId };
            var initial = data.callerName.charAt(0).toUpperCase();
            var callTypeText = data.callType === 'video' ? 'Видеозвонок' : 'Аудиозвонок';
            
            document.getElementById('modals').innerHTML = `
                <div class="fixed inset-0 modal-overlay flex items-center justify-center z-50 fade-in">
                    <div class="bg-gray-800 rounded-3xl p-8 text-center max-w-sm w-full mx-4 shadow-2xl">
                        <div class="w-24 h-24 mx-auto rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-3xl font-bold mb-4 pulse-call">${initial}</div>
                        <h3 class="text-xl font-semibold mb-2">${escapeHtml(data.callerName)}</h3>
                        <p class="text-white/50 mb-8">${callTypeText}</p>
                        <div class="flex justify-center gap-6">
                            <button onclick="rejectCall()" class="w-16 h-16 rounded-full bg-red-500 hover:bg-red-600 flex items-center justify-center transition shadow-lg shadow-red-500/30">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                            <button onclick="acceptCall()" class="w-16 h-16 rounded-full bg-green-500 hover:bg-green-600 flex items-center justify-center transition shadow-lg shadow-green-500/30">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        function acceptCall() {
            ws.send(JSON.stringify({
                type: 'call_accept',
                callId: currentCall.id
            }));
            
            showCallUI(currentCall.type, 'Звонок', false);
            startWebRTCConnection(false);
        }
        function rejectCall() {
            ws.send(JSON.stringify({
                type: 'call_reject',
                callId: currentCall.id
            }));
            
            document.getElementById('modals').innerHTML = '';
            currentCall = null;
        }
        function showCallUI(type, name, isWaiting) {
            var initial = name.charAt(0).toUpperCase();
            var statusText = isWaiting ? 'Вызов...' : 'Соединение...';
            var pulseClass = isWaiting ? 'pulse-call' : '';
            
            var videoHtml = type === 'video' 
                ? '<div class="relative mb-4 bg-gray-900 rounded-2xl overflow-hidden" style="aspect-ratio: 16/9;"><video id="remoteVideo" autoplay playsinline class="w-full h-full object-cover"></video><video id="localVideo" autoplay playsinline muted class="absolute bottom-4 right-4 w-32 rounded-xl bg-gray-700 shadow-lg"></video></div>'
                : '<div class="w-28 h-28 mx-auto rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-4xl font-bold mb-4 ' + pulseClass + '">' + initial + '</div>';
            
            document.getElementById('modals').innerHTML = `
                <div class="fixed inset-0 modal-overlay flex items-center justify-center z-50 fade-in">
                    <div class="bg-gray-800 rounded-3xl p-8 text-center max-w-md w-full mx-4 shadow-2xl">
                        ${videoHtml}
                        <h3 class="text-xl font-semibold mb-2">${escapeHtml(name)}</h3>
                        <p class="text-white/50 mb-4" id="callStatus">${statusText}</p>
                        <p class="text-3xl font-mono mb-6 text-purple-300" id="callTimer">00:00</p>
                        <div class="flex justify-center gap-4">
                            <button id="muteBtn" onclick="toggleMute()" class="w-14 h-14 rounded-full bg-gray-700 hover:bg-gray-600 flex items-center justify-center transition">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                                </svg>
                            </button>
                            <button onclick="endCallAction()" class="w-14 h-14 rounded-full bg-red-500 hover:bg-red-600 flex items-center justify-center transition shadow-lg shadow-red-500/30">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        async function startWebRTCConnection(isInitiator) {
            try {
                var constraints = {
                    audio: true,
                    video: currentCall.type === 'video'
                };
                
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                if (currentCall.type === 'video') {
                    var localVideo = document.getElementById('localVideo');
                    if (localVideo) localVideo.srcObject = localStream;
                }
                
                peerConnection = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                localStream.getTracks().forEach(function(track) {
                    peerConnection.addTrack(track, localStream);
                });
                
                peerConnection.ontrack = function(event) {
                    var remoteVideo = document.getElementById('remoteVideo');
                    if (remoteVideo && event.streams[0]) {
                        remoteVideo.srcObject = event.streams[0];
                    }
                    
                    var statusEl = document.getElementById('callStatus');
                    if (statusEl) statusEl.textContent = 'На связи';
                    
                    callStartTime = Date.now();
                    callTimerInterval = setInterval(updateCallTimer, 1000);
                };
                
                peerConnection.onicecandidate = function(event) {
                    if (event.candidate) {
                        var targetId = currentCall.isInitiator ? currentChat.otherUserId : currentCall.callerId;
                        ws.send(JSON.stringify({
                            type: 'webrtc_ice',
                            candidate: event.candidate,
                            targetUserId: targetId
                        }));
                    }
                };
                
                if (isInitiator) {
                    var offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    ws.send(JSON.stringify({
                        type: 'webrtc_offer',
                        offer: offer,
                        targetUserId: currentChat.otherUserId
                    }));
                }
            } catch (e) {
                console.error('WebRTC error:', e);
                alert('Не удалось получить доступ к камере/микрофону');
                endCall();
            }
        }
        async function handleWebRTCOffer(data) {
            if (peerConnection) {
                await peerConnection.setRemoteDescription(data.offer);
                var answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                ws.send(JSON.stringify({
                    type: 'webrtc_answer',
                    answer: answer,
                    targetUserId: currentCall.callerId
                }));
            }
        }
        async function handleWebRTCAnswer(data) {
            if (peerConnection) {
                await peerConnection.setRemoteDescription(data.answer);
            }
        }
        async function handleICECandidate(data) {
            if (peerConnection && data.candidate) {
                await peerConnection.addIceCandidate(data.candidate);
            }
        }
        function updateCallTimer() {
            var elapsed = Math.floor((Date.now() - callStartTime) / 1000);
            var mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
            var secs = (elapsed % 60).toString().padStart(2, '0');
            var timerEl = document.getElementById('callTimer');
            if (timerEl) timerEl.textContent = mins + ':' + secs;
        }
        function toggleMute() {
            if (localStream) {
                var audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    var btn = document.getElementById('muteBtn');
                    if (audioTrack.enabled) {
                        btn.classList.remove('bg-red-500');
                        btn.classList.add('bg-gray-700');
                    } else {
                        btn.classList.remove('bg-gray-700');
                        btn.classList.add('bg-red-500');
                    }
                }
            }
        }
        function endCallAction() {
            if (currentCall) {
                ws.send(JSON.stringify({
                    type: 'call_end',
                    callId: currentCall.id
                }));
            }
            endCall();
        }
        function endCall() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            if (localStream) {
                localStream.getTracks().forEach(function(track) { track.stop(); });
                localStream = null;
            }
            
            clearInterval(callTimerInterval);
            callTimerInterval = null;
            callStartTime = null;
            
            var modals = document.getElementById('modals');
            if (modals) modals.innerHTML = '';
            currentCall = null;
        }
        // Settings
        function showSettings() {
            var displayName = currentUser.displayName || '';
            var email = currentUser.email || '';
            
            document.getElementById('modals').innerHTML = `
                <div class="fixed inset-0 modal-overlay flex items-center justify-center z-50 fade-in">
                    <div class="bg-gray-800 rounded-3xl p-6 max-w-md w-full mx-4 shadow-2xl">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-semibold">Настройки профиля</h2>
                            <button onclick="closeSettings()" class="p-2 hover:bg-white/10 rounded-lg transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm text-white/70 mb-2">Отображаемое имя</label>
                                <input type="text" id="settingsDisplayName" value="${escapeHtml(displayName)}"
                                    class="input-field w-full rounded-xl px-4 py-3 outline-none text-white">
                            </div>
                            
                            <div>
                                <label class="block text-sm text-white/70 mb-2">Email (для восстановления пароля)</label>
                                <input type="email" id="settingsEmail" value="${escapeHtml(email)}" placeholder="example@mail.com"
                                    class="input-field w-full rounded-xl px-4 py-3 outline-none text-white placeholder-white/40">
                            </div>
                            
                            <button onclick="saveSettings()" 
                                class="btn-primary w-full rounded-xl py-3 font-semibold text-white mt-6">
                                Сохранить
                            </button>
                        </div>
                        
                        <div id="settingsMessage" class="mt-4 text-center hidden"></div>
                    </div>
                </div>
            `;
        }
        async function saveSettings() {
            var displayName = document.getElementById('settingsDisplayName').value.trim();
            var email = document.getElementById('settingsEmail').value.trim();
            
            if (!displayName) {
                var msg = document.getElementById('settingsMessage');
                msg.textContent = 'Введите имя';
                msg.className = 'mt-4 text-center text-red-400';
                msg.classList.remove('hidden');
                return;
            }
            
            try {
                var res = await fetch(API_URL + '/api/user/' + currentUser.id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ displayName: displayName, email: email })
                });
                
                var data = await res.json();
                
                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('maxutra_user', JSON.stringify(currentUser));
                    
                    var msg = document.getElementById('settingsMessage');
                    msg.textContent = 'Настройки сохранены!';
                    msg.className = 'mt-4 text-center text-green-400';
                    msg.classList.remove('hidden');
                    
                    setTimeout(function() {
                        closeSettings();
                        renderMainApp();
                    }, 1000);
                }
            } catch (e) {
                console.error('Error saving settings:', e);
            }
        }
        function closeSettings() {
            document.getElementById('modals').innerHTML = '';
        }
        async function logout() {
            try {
                await fetch(API_URL + '/api/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.id })
                });
            } catch (e) {
                console.error('Error logging out:', e);
            }
            
            if (ws) {
                ws.close();
                ws = null;
            }
            localStorage.removeItem('maxutra_user');
            currentUser = null;
            currentChat = null;
            otherUserData = null;
            renderAuth();
        }
        // Helpers
        function formatTime(timestamp) {
            var date = new Date(timestamp);
            var now = new Date();
            
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            }
            
            return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
        }
        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        // Initialize app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
