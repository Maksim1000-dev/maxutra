<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maxutra - –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .chat-bubble-sent {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px 20px 5px 20px;
        }
        
        .chat-bubble-received {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px 20px 20px 5px;
        }
        
        .sidebar {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
        }
        
        .chat-area {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
        }
        
        .user-online::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: #10b981;
            border-radius: 50%;
            border: 2px solid #1a1a2e;
        }
        
        .user-offline::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: #6b7280;
            border-radius: 50%;
            border: 2px solid #1a1a2e;
        }
        
        .message-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.5);
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .pulse-call {
            animation: pulseCall 1.5s ease-in-out infinite;
        }
        
        @keyframes pulseCall {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(102, 126, 234, 0); }
        }
        
        .typing-indicator span {
            animation: typing 1.4s infinite;
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            margin: 0 2px;
        }
        
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 3px; }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .input-field {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            background: rgba(255, 255, 255, 0.12);
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        
        .chat-item:hover { background: rgba(255, 255, 255, 0.08); }
        
        .chat-item.active {
            background: rgba(102, 126, 234, 0.2);
            border-left: 3px solid #667eea;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –∂–∞–ª–æ–±—ã */
        .report-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .message-wrapper:hover .report-btn {
            opacity: 1;
        }
        
        /* –£–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–æ–≤ - –ü–ö */
        .chat-delete-btn {
            opacity: 0;
            transition: all 0.2s;
        }
        
        .chat-item:hover .chat-delete-btn {
            opacity: 1;
        }
        
        /* –°–≤–∞–π–ø –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —á–∞—Ç–∞ - –º–æ–±–∏–ª—å–Ω—ã–µ */
        .chat-item-wrapper {
            position: relative;
            overflow: hidden;
        }
        
        .chat-item-content {
            position: relative;
            z-index: 1;
            background: inherit;
            transition: transform 0.3s ease;
        }
        
        .chat-delete-bg {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 100px;
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            z-index: 0;
        }
        
        .chat-item-content.swiping {
            transition: none;
        }
        
        .chat-item-content.deleting {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        /* –ú–æ–±–∏–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                width: 100%;
                z-index: 40;
                transition: transform 0.3s ease;
            }
            
            .sidebar.hidden-mobile {
                transform: translateX(-100%);
            }
            
            .chat-area {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                right: 0;
                z-index: 30;
            }
            
            .back-btn-mobile {
                display: flex !important;
            }
            
            .chat-delete-btn {
                display: none !important;
            }
        }
        
        @media (min-width: 769px) {
            .back-btn-mobile {
                display: none !important;
            }
            
            .chat-delete-bg {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div id="app">
        <div class="min-h-screen flex items-center justify-center">
            <div class="text-center">
                <div class="w-16 h-16 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-white/70">–ó–∞–≥—Ä—É–∑–∫–∞ Maxutra...</p>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–æ–¥—É–ª–∏ -->
    <script src="permissions.js"></script>
    <script src="call.js"></script>
    <script src="group.js"></script>
    
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        window.API_URL = window.location.origin;
        window.currentUser = null;
        window.currentChat = null;
        window.ws = null;
        window.otherUserData = null;
        
        let typingTimeout = null;

        // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –∏–∑ localStorage
        function safeGetUser() {
            try {
                const saved = localStorage.getItem('maxutra_user');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (parsed && parsed.id && parsed.username) {
                        return parsed;
                    }
                }
            } catch (e) {
                console.log('–û—á–∏—Å—Ç–∫–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö');
                localStorage.removeItem('maxutra_user');
            }
            return null;
        }

        // Initialize app
        function init() {
            window.currentUser = safeGetUser();
            if (window.currentUser) {
                connectWebSocket();
                renderMainApp();
            } else {
                renderAuth();
            }
        }

        // WebSocket connection
        function connectWebSocket() {
            if (!window.currentUser) return;
            
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            window.ws = new WebSocket(wsProtocol + '//' + window.location.host);
            
            window.ws.onopen = function() {
                console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                window.ws.send(JSON.stringify({ type: 'auth', userId: window.currentUser.id }));
            };
            
            window.ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:', e);
                }
            };
            
            window.ws.onclose = function() {
                console.log('WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
                setTimeout(function() {
                    if (window.currentUser) connectWebSocket();
                }, 3000);
            };
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'new_message':
                    if (window.currentChat && data.message.chatId === window.currentChat.id) {
                        appendMessage(data.message);
                    }
                    // –ó–≤—É–∫ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–µ—Å–ª–∏ –Ω–µ —Å–≤–æ—ë)
                    if (data.message.senderId !== window.currentUser.id) {
                        playMessageSound();
                    }
                    loadChats();
                    break;
                    
                case 'incoming_call':
                    CallManager.showIncomingCall(data);
                    break;
                    
                case 'call_accepted':
                    CallManager.onCallAccepted();
                    break;
                    
                case 'call_ended':
                    CallManager.cleanup();
                    break;
                    
                case 'webrtc_offer':
                    CallManager.handleOffer(data);
                    break;
                    
                case 'webrtc_answer':
                    CallManager.handleAnswer(data);
                    break;
                    
                case 'webrtc_ice':
                    CallManager.handleIceCandidate(data);
                    break;
                    
                case 'user_typing':
                    showTypingIndicator(data);
                    break;
                    
                case 'group_call_invite':
                    showGroupCallInvite(data);
                    break;
                    
                case 'blocked':
                    localStorage.removeItem('maxutra_user');
                    window.currentUser = null;
                    showBlockedScreen('–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', data.reason, data.until);
                    break;
                    
                case 'account_deleted':
                    localStorage.removeItem('maxutra_user');
                    window.currentUser = null;
                    alert('–ê–∫–∫–∞—É–Ω—Ç —É–¥–∞–ª—ë–Ω –∑–∞ –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è');
                    renderAuth();
                    break;
            }
        }
        
        function showGroupCallInvite(data) {
            const html = `
                <div class="fixed inset-0 modal-overlay flex items-center justify-center z-50 fade-in" id="groupCallInviteModal">
                    <div class="bg-gray-800 rounded-3xl p-8 text-center max-w-sm w-full mx-4 shadow-2xl">
                        <div class="w-24 h-24 mx-auto rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-3xl font-bold mb-4 pulse-call">
                            üë•
                        </div>
                        <h3 class="text-xl font-semibold mb-2">–ì—Ä—É–ø–ø–æ–≤–æ–π –∑–≤–æ–Ω–æ–∫</h3>
                        <p class="text-white/50 mb-6">${escapeHtml(data.callerName)} –ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç</p>
                        <div class="flex justify-center gap-6">
                            <button onclick="rejectGroupCallInvite()" class="w-16 h-16 rounded-full bg-red-500 hover:bg-red-600 flex items-center justify-center transition">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                            <button onclick="acceptGroupCallInvite()" class="w-16 h-16 rounded-full bg-green-500 hover:bg-green-600 flex items-center justify-center transition">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modals').innerHTML = html;
            window._pendingGroupCall = data;
        }
        
        function acceptGroupCallInvite() {
            const data = window._pendingGroupCall;
            if (data) {
                GroupManager.startGroupCall(data.groupId, data.participants, data.callType);
            }
            document.getElementById('modals').innerHTML = '';
        }
        
        function rejectGroupCallInvite() {
            document.getElementById('modals').innerHTML = '';
            window._pendingGroupCall = null;
        }

        // Auth screens
        function renderAuth() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen gradient-bg flex items-center justify-center p-4">
                    <div class="glass rounded-3xl p-8 w-full max-w-md fade-in">
                        <div class="text-center mb-8">
                            <div class="w-20 h-20 mx-auto mb-4 rounded-2xl bg-white/20 flex items-center justify-center">
                                <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
                                </svg>
                            </div>
                            <h1 class="text-4xl font-bold mb-2">Maxutra</h1>
                            <p class="text-white/70">–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</p>
                        </div>
                        
                        <div id="authForm">
                            <div id="loginForm">
                                <input type="text" id="loginUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" 
                                    class="input-field w-full rounded-xl px-4 py-3 mb-4 outline-none text-white placeholder-white/50">
                                <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" 
                                    class="input-field w-full rounded-xl px-4 py-3 mb-6 outline-none text-white placeholder-white/50">
                                <button onclick="login()" class="btn-primary w-full rounded-xl py-3 font-semibold">–í–æ–π—Ç–∏</button>
                                <div class="flex justify-between mt-6 text-sm">
                                    <button onclick="showRegister()" class="text-purple-200 hover:text-white">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                                    <button onclick="showForgotPassword()" class="text-purple-200 hover:text-white">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="errorMessage" class="mt-4 p-3 bg-red-500/20 border border-red-500/50 rounded-xl text-red-300 text-center hidden"></div>
                    </div>
                </div>
            `;
        }

        function showRegister() {
            document.getElementById('authForm').innerHTML = `
                <div id="registerForm" class="fade-in">
                    <input type="text" id="regDisplayName" placeholder="–í–∞—à–µ –∏–º—è" 
                        class="input-field w-full rounded-xl px-4 py-3 mb-4 outline-none text-white placeholder-white/50">
                    <input type="text" id="regUsername" placeholder="–õ–æ–≥–∏–Ω (–¥–ª—è –≤—Ö–æ–¥–∞)" 
                        class="input-field w-full rounded-xl px-4 py-3 mb-4 outline-none text-white placeholder-white/50">
                    <input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å" 
                        class="input-field w-full rounded-xl px-4 py-3 mb-4 outline-none text-white placeholder-white/50">
                    <input type="text" id="regSecretCode" placeholder="–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥ (–¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è)" 
                        class="input-field w-full rounded-xl px-4 py-3 mb-3 outline-none text-white placeholder-white/50">
                    <p class="text-xs text-white/50 mb-6 text-center">–ó–∞–ø–æ–º–Ω–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥!</p>
                    <button onclick="register()" class="btn-primary w-full rounded-xl py-3 font-semibold">–°–æ–∑–¥–∞—Ç—å</button>
                    <button onclick="renderAuth()" class="w-full mt-4 py-2 text-purple-200 hover:text-white">‚Üê –ù–∞–∑–∞–¥</button>
                </div>
            `;
        }

        function showForgotPassword() {
            document.getElementById('authForm').innerHTML = `
                <div id="forgotForm" class="fade-in">
                    <h3 class="text-lg font-semibold mb-6 text-center">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</h3>
                    <input type="text" id="forgotUsername" placeholder="–í–∞—à –ª–æ–≥–∏–Ω" 
                        class="input-field w-full rounded-xl px-4 py-3 mb-4 outline-none text-white placeholder-white/50">
                    <input type="text" id="forgotSecretCode" placeholder="–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥" 
                        class="input-field w-full rounded-xl px-4 py-3 mb-4 outline-none text-white placeholder-white/50">
                    <div class="text-center text-white/50 text-sm mb-4">–∏–ª–∏</div>
                    <input type="email" id="forgotEmail" placeholder="Email (–µ—Å–ª–∏ —É–∫–∞–∑—ã–≤–∞–ª–∏)" 
                        class="input-field w-full rounded-xl px-4 py-3 mb-6 outline-none text-white placeholder-white/50">
                    <button onclick="forgotPassword()" class="btn-primary w-full rounded-xl py-3 font-semibold">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                    <button onclick="renderAuth()" class="w-full mt-4 py-2 text-purple-200 hover:text-white">‚Üê –ù–∞–∑–∞–¥</button>
                    <div id="recoveredPassword" class="mt-6 p-4 bg-green-500/20 border border-green-500/50 rounded-xl hidden">
                        <p class="text-green-300 text-center">–í–∞—à –ø–∞—Ä–æ–ª—å: <span id="passwordDisplay" class="font-bold text-white"></span></p>
                    </div>
                </div>
            `;
        }

        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            try {
                const res = await fetch(window.API_URL + '/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    window.currentUser = data.user;
                    localStorage.setItem('maxutra_user', JSON.stringify(window.currentUser));
                    connectWebSocket();
                    renderMainApp();
                } else if (data.error === 'blocked') {
                    showBlockedScreen(data.message, data.reason, data.until);
                } else {
                    showError(data.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
                }
            } catch (e) {
                showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            }
        }
        
        function showBlockedScreen(message, reason, until) {
            const untilDate = until ? new Date(until).toLocaleDateString('ru-RU', { 
                day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' 
            }) : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-red-900 to-gray-900 flex items-center justify-center p-4">
                    <div class="bg-gray-800/80 backdrop-blur rounded-3xl p-8 max-w-md w-full text-center">
                        <div class="w-20 h-20 mx-auto mb-6 rounded-full bg-red-500/20 flex items-center justify-center">
                            <svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                        </div>
                        <h1 class="text-2xl font-bold text-red-400 mb-4">–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</h1>
                        <p class="text-white/70 mb-4">${escapeHtml(message || '')}</p>
                        <div class="bg-red-500/10 border border-red-500/30 rounded-xl p-4 mb-6">
                            <p class="text-sm text-white/50 mb-1">–ü—Ä–∏—á–∏–Ω–∞:</p>
                            <p class="text-white">${escapeHtml(reason || '–ù–µ —É–∫–∞–∑–∞–Ω–∞')}</p>
                            <p class="text-sm text-white/50 mt-3">–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–æ:</p>
                            <p class="text-white">${untilDate}</p>
                        </div>
                        <button onclick="renderAuth()" class="w-full py-3 rounded-xl bg-gray-700 hover:bg-gray-600 transition">–ù–∞–∑–∞–¥</button>
                    </div>
                </div>
            `;
        }

        async function register() {
            const displayName = document.getElementById('regDisplayName').value.trim();
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;
            const secretCode = document.getElementById('regSecretCode').value.trim();
            
            if (!displayName || !username || !password || !secretCode) {
                showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            try {
                const res = await fetch(window.API_URL + '/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, secretCode, displayName })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    window.currentUser = data.user;
                    localStorage.setItem('maxutra_user', JSON.stringify(window.currentUser));
                    connectWebSocket();
                    renderMainApp();
                } else {
                    showError(data.error || '–û—à–∏–±–∫–∞');
                }
            } catch (e) {
                showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            }
        }

        async function forgotPassword() {
            const username = document.getElementById('forgotUsername').value.trim();
            const secretCode = document.getElementById('forgotSecretCode').value.trim();
            const email = document.getElementById('forgotEmail').value.trim();
            
            if (!username || (!secretCode && !email)) {
                showError('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –∫–æ–¥ –∏–ª–∏ email');
                return;
            }
            
            try {
                const res = await fetch(window.API_URL + '/api/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, secretCode, email })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    document.getElementById('recoveredPassword').classList.remove('hidden');
                    document.getElementById('passwordDisplay').textContent = data.password;
                } else {
                    showError(data.error || '–û—à–∏–±–∫–∞');
                }
            } catch (e) {
                showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            }
        }

        function showError(message) {
            const el = document.getElementById('errorMessage');
            if (el) {
                el.textContent = message;
                el.classList.remove('hidden');
                setTimeout(() => el.classList.add('hidden'), 4000);
            }
        }

        // Main App
        function renderMainApp() {
            const devSettings = GroupManager.getDevSettings();
            
            document.getElementById('app').innerHTML = `
                <div class="flex h-screen">
                    <!-- Sidebar -->
                    <div class="sidebar w-80 flex flex-col border-r border-white/10">
                        <div class="p-4 border-b border-white/10">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center font-bold">
                                        ${window.currentUser.displayName ? window.currentUser.displayName.charAt(0).toUpperCase() : 'U'}
                                    </div>
                                    <div>
                                        <h1 class="font-bold text-lg bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-400">Maxutra</h1>
                                        <p class="text-xs text-white/50">${escapeHtml(window.currentUser.displayName || window.currentUser.username)}</p>
                                    </div>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="GroupManager.showCreateGroupDialog()" class="p-2 hover:bg-white/10 rounded-lg transition" title="–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É">
                                        <svg class="w-5 h-5 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                    </button>
                                    <button onclick="showSettings()" class="p-2 hover:bg-white/10 rounded-lg transition" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                                        <svg class="w-5 h-5 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                    </button>
                                    <button onclick="logout()" class="p-2 hover:bg-white/10 rounded-lg transition" title="–í—ã–π—Ç–∏">
                                        <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Search -->
                            <div class="relative">
                                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π..." 
                                    oninput="searchUsers()"
                                    class="input-field w-full rounded-xl px-4 py-2.5 pl-10 outline-none text-white placeholder-white/50 text-sm">
                                <svg class="w-4 h-4 absolute left-3.5 top-3 text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <div id="searchResults" class="mt-2 max-h-60 overflow-y-auto hidden bg-gray-800/90 rounded-xl"></div>
                        </div>
                        
                        <!-- Chats list -->
                        <div class="flex-1 overflow-y-auto scrollbar-thin" id="chatsList">
                            <div class="p-8 text-center text-white/50">
                                <div class="w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
                                <p>–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chat area -->
                    <div class="flex-1 chat-area flex flex-col" id="chatArea">
                        <div class="flex-1 flex items-center justify-center text-white/50">
                            <div class="text-center p-8">
                                <div class="w-24 h-24 mx-auto mb-6 rounded-3xl bg-white/5 flex items-center justify-center">
                                    <svg class="w-12 h-12 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-xl font-semibold text-white/70 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                                <p class="text-sm">–∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Modals container -->
                <div id="modals"></div>
            `;
            
            loadChats();
        }

        async function loadChats() {
            try {
                const res = await fetch(window.API_URL + '/api/chats/' + window.currentUser.id);
                const chats = await res.json();
                
                const chatsList = document.getElementById('chatsList');
                if (!chatsList) return;
                
                if (chats.length === 0) {
                    chatsList.innerHTML = `
                        <div class="p-8 text-center text-white/50">
                            <svg class="w-16 h-16 mx-auto mb-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <p class="font-medium mb-1">–ù–µ—Ç —á–∞—Ç–æ–≤</p>
                            <p class="text-sm">–ù–∞–π–¥–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫</p>
                        </div>
                    `;
                    return;
                }
                
                chatsList.innerHTML = chats.map(chat => {
                    const isActive = window.currentChat && window.currentChat.id === chat.id;
                    const otherUser = chat.otherUser || {};
                    const initial = otherUser.displayName ? otherUser.displayName.charAt(0).toUpperCase() : '?';
                    const statusClass = otherUser.status === 'online' ? 'user-online' : 'user-offline';
                    const lastMsg = chat.lastMessage ? chat.lastMessage.content : '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
                    const lastTime = chat.lastMessage ? formatTime(chat.lastMessage.timestamp) : '';
                    
                    return `<div class="chat-item-wrapper" data-chat-id="${chat.id}">
                        <div class="chat-delete-bg">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </div>
                        <div class="chat-item-content chat-item p-4 cursor-pointer transition border-b border-white/5 ${isActive ? 'active' : ''}"
                            onclick="openChat('${chat.id}', '${otherUser.id}')"
                            ontouchstart="handleTouchStart(event, '${chat.id}')"
                            ontouchmove="handleTouchMove(event, '${chat.id}')"
                            ontouchend="handleTouchEnd(event, '${chat.id}')">
                            <div class="flex items-center gap-3">
                                <div class="relative ${statusClass}">
                                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-lg font-semibold">${initial}</div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-center">
                                        <h3 class="font-semibold truncate">${escapeHtml(otherUser.displayName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π')}</h3>
                                        <span class="text-xs text-white/30 ml-2">${lastTime}</span>
                                    </div>
                                    <p class="text-sm text-white/50 truncate">${escapeHtml(lastMsg.length > 30 ? lastMsg.slice(0, 30) + '...' : lastMsg)}</p>
                                </div>
                                <button onclick="event.stopPropagation(); confirmDeleteChat('${chat.id}')" 
                                    class="chat-delete-btn p-2 hover:bg-red-500/20 rounded-lg transition text-white/30 hover:text-red-400" title="–£–¥–∞–ª–∏—Ç—å —á–∞—Ç">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>`;
                }).join('');
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–≤–∞–π–ø–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
                initSwipeHandlers();
            } catch (e) {
                console.error('Error loading chats:', e);
            }
        }
        
        // –°–≤–∞–π–ø –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —á–∞—Ç–æ–≤ (–º–æ–±–∏–ª—å–Ω—ã–µ)
        let touchStartX = 0;
        let touchCurrentX = 0;
        let isSwiping = false;
        let swipeChatId = null;
        
        function handleTouchStart(e, chatId) {
            touchStartX = e.touches[0].clientX;
            touchCurrentX = touchStartX;
            isSwiping = true;
            swipeChatId = chatId;
            
            const content = e.currentTarget;
            content.classList.add('swiping');
        }
        
        function handleTouchMove(e, chatId) {
            if (!isSwiping || chatId !== swipeChatId) return;
            
            touchCurrentX = e.touches[0].clientX;
            const diff = touchStartX - touchCurrentX;
            
            const content = e.currentTarget;
            
            if (diff > 0 && diff < 120) {
                content.style.transform = `translateX(-${diff}px)`;
            }
        }
        
        function handleTouchEnd(e, chatId) {
            if (!isSwiping || chatId !== swipeChatId) return;
            
            const content = e.currentTarget;
            content.classList.remove('swiping');
            
            const diff = touchStartX - touchCurrentX;
            
            if (diff > 80) {
                // –£–¥–∞–ª—è–µ–º —á–∞—Ç
                content.classList.add('deleting');
                setTimeout(() => deleteChat(chatId), 300);
            } else {
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞ –º–µ—Å—Ç–æ
                content.style.transform = '';
            }
            
            isSwiping = false;
            swipeChatId = null;
        }
        
        function initSwipeHandlers() {
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –µ—Å–ª–∏ –Ω—É–∂–Ω–∞
        }
        
        function confirmDeleteChat(chatId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç? –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) {
                deleteChat(chatId);
            }
        }
        
        async function deleteChat(chatId) {
            try {
                const res = await fetch(window.API_URL + '/api/chats/' + chatId + '?userId=' + window.currentUser.id, {
                    method: 'DELETE'
                });
                
                const data = await res.json();
                
                if (data.success) {
                    // –ï—Å–ª–∏ —É–¥–∞–ª—ë–Ω–Ω—ã–π —á–∞—Ç –±—ã–ª –æ—Ç–∫—Ä—ã—Ç, –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
                    if (window.currentChat && window.currentChat.id === chatId) {
                        window.currentChat = null;
                        document.getElementById('chatArea').innerHTML = `
                            <div class="flex-1 flex items-center justify-center text-white/50">
                                <div class="text-center p-8">
                                    <div class="w-24 h-24 mx-auto mb-6 rounded-3xl bg-white/5 flex items-center justify-center">
                                        <svg class="w-12 h-12 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                        </svg>
                                    </div>
                                    <h3 class="text-xl font-semibold text-white/70 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                                    <p class="text-sm">–∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</p>
                                </div>
                            </div>
                        `;
                    }
                    
                    showToast('–ß–∞—Ç —É–¥–∞–ª—ë–Ω');
                    loadChats();
                }
            } catch (e) {
                console.error('Error deleting chat:', e);
                showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            }
        }

        async function searchUsers() {
            const query = document.getElementById('searchInput').value.trim();
            const resultsEl = document.getElementById('searchResults');
            
            if (query.length < 2) {
                resultsEl.classList.add('hidden');
                return;
            }
            
            try {
                const res = await fetch(window.API_URL + '/api/users/search?query=' + encodeURIComponent(query) + '&currentUserId=' + window.currentUser.id);
                const users = await res.json();
                
                if (users.length === 0) {
                    resultsEl.innerHTML = '<div class="p-4 text-white/50 text-sm text-center">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                } else {
                    resultsEl.innerHTML = users.map(user => {
                        const initial = user.displayName.charAt(0).toUpperCase();
                        const statusClass = user.status === 'online' ? 'user-online' : 'user-offline';
                        return `<div onclick="startChatWith('${user.id}')" class="p-3 hover:bg-white/10 cursor-pointer transition flex items-center gap-3">
                            <div class="relative ${statusClass}">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center font-semibold">${initial}</div>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium">${escapeHtml(user.displayName)}</p>
                                <p class="text-xs text-white/50">@${escapeHtml(user.username)}</p>
                            </div>
                        </div>`;
                    }).join('');
                }
                
                resultsEl.classList.remove('hidden');
            } catch (e) {
                console.error('Error:', e);
            }
        }

        async function startChatWith(userId) {
            try {
                const res = await fetch(window.API_URL + '/api/chats', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId1: window.currentUser.id, userId2: userId })
                });
                
                const chat = await res.json();
                document.getElementById('searchInput').value = '';
                document.getElementById('searchResults').classList.add('hidden');
                await loadChats();
                openChat(chat.id, userId);
            } catch (e) {
                console.error('Error:', e);
            }
        }

        async function openChat(chatId, otherUserId) {
            window.currentChat = { id: chatId, otherUserId: otherUserId };
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Å–∞–π–¥–±–∞—Ä –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
            if (isMobile()) {
                const sidebar = document.querySelector('.sidebar');
                if (sidebar) {
                    sidebar.classList.add('hidden-mobile');
                }
            }
            
            try {
                const usersRes = await fetch(window.API_URL + '/api/users?currentUserId=' + window.currentUser.id);
                const users = await usersRes.json();
                window.otherUserData = users.find(u => u.id === otherUserId) || {};
                
                const messagesRes = await fetch(window.API_URL + '/api/messages/' + chatId);
                const messages = await messagesRes.json();
                
                const initial = window.otherUserData.displayName ? window.otherUserData.displayName.charAt(0).toUpperCase() : '?';
                const statusClass = window.otherUserData.status === 'online' ? 'user-online' : 'user-offline';
                const statusText = window.otherUserData.status === 'online' ? '–í —Å–µ—Ç–∏' : '–ù–µ –≤ —Å–µ—Ç–∏';
                
                const messagesHtml = messages.length === 0 
                    ? '<div class="text-center text-white/50 mt-10"><p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!</p></div>'
                    : messages.map(m => renderMessage(m)).join('');
                
                const devSettings = GroupManager.getDevSettings();
                
                // –ö–Ω–æ–ø–∫–∞ —ç–º–æ–¥–∑–∏/—Å—Ç–∏–∫–µ—Ä–æ–≤
                const emojiBtn = devSettings.emojiEnabled ? `
                    <div class="relative">
                        <button onclick="toggleEmojiPanel()" class="p-3 hover:bg-white/10 rounded-xl transition" title="–≠–º–æ–¥–∑–∏ –∏ —Å—Ç–∏–∫–µ—Ä—ã">
                            <svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </button>
                        ${GroupManager.getEmojiStickerPanelHTML()}
                    </div>
                ` : '';
                
                // –ö–Ω–æ–ø–∫–∞ –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ –∑–≤–æ–Ω–∫–∞
                const groupCallBtn = devSettings.groupCallsEnabled ? `
                    <button onclick="GroupManager.showGroupCallDialog('${otherUserId}')" class="p-3 hover:bg-white/10 rounded-xl transition" title="–ì—Ä—É–ø–ø–æ–≤–æ–π –∑–≤–æ–Ω–æ–∫">
                        <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </button>
                ` : '';
                
                document.getElementById('chatArea').innerHTML = `
                    <!-- Chat header -->
                    <div class="p-4 border-b border-white/10 flex items-center justify-between bg-black/20">
                        <div class="flex items-center gap-3">
                            <button onclick="goBackToChats()" class="back-btn-mobile p-2 -ml-2 hover:bg-white/10 rounded-lg transition">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>
                            <div class="relative ${statusClass}">
                                <div class="w-11 h-11 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center font-semibold text-lg">${initial}</div>
                            </div>
                            <div>
                                <h3 class="font-semibold">${escapeHtml(window.otherUserData.displayName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π')}</h3>
                                <p class="text-xs text-white/50">${statusText}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            ${groupCallBtn}
                            <button onclick="startCall('audio')" class="p-3 hover:bg-white/10 rounded-xl transition" title="–ê—É–¥–∏–æ–∑–≤–æ–Ω–æ–∫">
                                <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                </svg>
                            </button>
                            <button onclick="startCall('video')" class="p-3 hover:bg-white/10 rounded-xl transition" title="–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫">
                                <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Messages -->
                    <div class="flex-1 overflow-y-auto p-4 scrollbar-thin" id="messagesContainer">
                        ${messagesHtml}
                    </div>
                    
                    <!-- Typing indicator -->
                    <div id="typingIndicator" class="px-4 py-2 hidden">
                        <div class="typing-indicator flex items-center gap-1 text-white/50 text-sm">
                            <span></span><span></span><span></span>
                            <span class="ml-2">${escapeHtml(window.otherUserData.displayName || '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫')} –ø–µ—á–∞—Ç–∞–µ—Ç...</span>
                        </div>
                    </div>
                    
                    <!-- Input -->
                    <div class="p-4 border-t border-white/10 bg-black/20">
                        <div class="flex gap-3 items-center">
                            ${emojiBtn}
                            <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                                onkeydown="handleMessageKeydown(event)"
                                oninput="sendTyping()"
                                class="message-input flex-1 bg-white/10 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-white/50">
                            <button onclick="sendMessage()" class="btn-primary px-5 py-3 rounded-xl flex items-center justify-center">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–∞–Ω–µ–ª—å —ç–º–æ–¥–∑–∏
                if (devSettings.emojiEnabled) {
                    GroupManager.renderEmojiStickerContent();
                }
                
                scrollToBottom();
                loadChats();
            } catch (e) {
                console.error('Error:', e);
            }
        }
        
        function toggleEmojiPanel() {
            const panel = document.getElementById('emojiStickerPanel');
            if (panel) {
                panel.classList.toggle('hidden');
                if (!panel.classList.contains('hidden')) {
                    GroupManager.renderEmojiStickerContent();
                }
            }
        }

        function renderMessage(message) {
            const isSent = message.senderId === window.currentUser.id;
            const bubbleClass = isSent ? 'chat-bubble-sent' : 'chat-bubble-received';
            const alignClass = isSent ? 'justify-end' : 'justify-start';
            const timeClass = isSent ? 'text-white/60' : 'text-white/40';
            
            // –ö–æ–Ω—Ç–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            let contentHtml = '';
            if (message.type === 'sticker') {
                contentHtml = `<img src="${escapeHtml(message.content)}" alt="sticker" class="max-w-[150px] max-h-[150px]" onerror="this.outerHTML='üé®'">`;
            } else {
                contentHtml = `<p class="break-words">${escapeHtml(message.content)}</p>`;
            }
            
            // –ö–Ω–æ–ø–∫–∞ –∂–∞–ª–æ–±—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è —á—É–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)
            const reportBtn = !isSent ? `
                <button onclick="showReportDialog('${message.id}', '${message.senderId}')" 
                    class="report-btn p-1.5 hover:bg-red-500/20 rounded-lg transition text-white/30 hover:text-red-400" 
                    title="–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </button>
            ` : '';
            
            return `
                <div class="message-wrapper flex ${alignClass} mb-3 slide-in group">
                    <div class="flex items-end gap-1 max-w-[75%]">
                        ${!isSent ? reportBtn : ''}
                        <div class="${bubbleClass} px-4 py-2.5 shadow-lg">
                            ${contentHtml}
                            <p class="text-xs ${timeClass} mt-1">${formatTime(message.timestamp)}</p>
                        </div>
                        ${isSent ? reportBtn : ''}
                    </div>
                </div>
            `;
        }
        
        // –î–∏–∞–ª–æ–≥ –∂–∞–ª–æ–±—ã
        function showReportDialog(messageId, senderId) {
            document.getElementById('modals').innerHTML = `
                <div class="fixed inset-0 modal-overlay flex items-center justify-center z-50 fade-in">
                    <div class="bg-gray-800 rounded-2xl p-6 max-w-sm w-full mx-4 shadow-2xl">
                        <h3 class="text-lg font-semibold mb-4">–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
                        <p class="text-white/60 text-sm mb-4">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∂–∞–ª–æ–±—ã:</p>
                        
                        <div class="space-y-2 mb-6">
                            <label class="flex items-center gap-3 p-3 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10 transition">
                                <input type="radio" name="reportReason" value="spam" class="accent-purple-500">
                                <span>–°–ø–∞–º</span>
                            </label>
                            <label class="flex items-center gap-3 p-3 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10 transition">
                                <input type="radio" name="reportReason" value="offensive" class="accent-purple-500">
                                <span>–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è</span>
                            </label>
                            <label class="flex items-center gap-3 p-3 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10 transition">
                                <input type="radio" name="reportReason" value="inappropriate" class="accent-purple-500">
                                <span>–ù–µ–ø—Ä–∏–µ–º–ª–µ–º—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç</span>
                            </label>
                            <label class="flex items-center gap-3 p-3 bg-white/5 rounded-xl cursor-pointer hover:bg-white/10 transition">
                                <input type="radio" name="reportReason" value="other" class="accent-purple-500">
                                <span>–î—Ä—É–≥–æ–µ</span>
                            </label>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="closeModal()" class="flex-1 py-3 rounded-xl bg-gray-700 hover:bg-gray-600 transition">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                            <button onclick="submitReport('${messageId}', '${senderId}')" class="flex-1 py-3 rounded-xl bg-red-600 hover:bg-red-700 transition font-medium">
                                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function closeModal() {
            document.getElementById('modals').innerHTML = '';
        }
        
        async function submitReport(messageId, senderId) {
            const reasonEl = document.querySelector('input[name="reportReason"]:checked');
            if (!reasonEl) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∂–∞–ª–æ–±—ã');
                return;
            }
            
            const reasonTexts = {
                'spam': '–°–ø–∞–º',
                'offensive': '–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è',
                'inappropriate': '–ù–µ–ø—Ä–∏–µ–º–ª–µ–º—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç',
                'other': '–î—Ä—É–≥–æ–µ'
            };
            
            try {
                await fetch(window.API_URL + '/api/report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messageId: messageId,
                        chatId: window.currentChat.id,
                        reporterId: window.currentUser.id,
                        reportedUserId: senderId,
                        reason: reasonTexts[reasonEl.value]
                    })
                });
                
                closeModal();
                showToast('–ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
            } catch (e) {
                console.error('Error:', e);
            }
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-800 px-6 py-3 rounded-xl shadow-xl border border-white/10 text-sm fade-in z-50';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function appendMessage(message) {
            const container = document.getElementById('messagesContainer');
            if (container) {
                const emptyMsg = container.querySelector('.text-center');
                if (emptyMsg) container.innerHTML = '';
                container.insertAdjacentHTML('beforeend', renderMessage(message));
                scrollToBottom();
            }
        }

        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            if (container) container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content || !window.currentChat) return;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —ç–º–æ–¥–∑–∏
            const panel = document.getElementById('emojiStickerPanel');
            if (panel) panel.classList.add('hidden');
            
            try {
                await fetch(window.API_URL + '/api/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chatId: window.currentChat.id,
                        senderId: window.currentUser.id,
                        content: content
                    })
                });
                
                input.value = '';
            } catch (e) {
                console.error('Error:', e);
            }
        }

        function handleMessageKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function sendTyping() {
            if (window.ws && window.ws.readyState === 1 && window.currentChat) {
                window.ws.send(JSON.stringify({
                    type: 'typing',
                    chatId: window.currentChat.id,
                    userId: window.currentUser.id
                }));
            }
        }

        function showTypingIndicator(data) {
            if (window.currentChat && data.chatId === window.currentChat.id && data.userId !== window.currentUser.id) {
                const indicator = document.getElementById('typingIndicator');
                if (indicator) {
                    indicator.classList.remove('hidden');
                    clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(() => indicator.classList.add('hidden'), 2000);
                }
            }
        }

        function startCall(type) {
            if (!window.currentChat || !window.otherUserData) return;
            CallManager.startCall(type, window.currentChat.otherUserId, window.otherUserData.displayName || '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫');
        }

        // Settings
        function showSettings() {
            const displayName = window.currentUser.displayName || '';
            const email = window.currentUser.email || '';
            
            document.getElementById('modals').innerHTML = `
                <div class="fixed inset-0 modal-overlay flex items-center justify-center z-50 fade-in">
                    <div class="bg-gray-800 rounded-3xl p-6 max-w-md w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-semibold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h2>
                            <button onclick="closeModal()" class="p-2 hover:bg-white/10 rounded-lg transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm text-white/70 mb-2">–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è</label>
                                <input type="text" id="settingsDisplayName" value="${escapeHtml(displayName)}"
                                    class="input-field w-full rounded-xl px-4 py-3 outline-none text-white">
                            </div>
                            
                            <div>
                                <label class="block text-sm text-white/70 mb-2">Email (–¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è)</label>
                                <input type="email" id="settingsEmail" value="${escapeHtml(email)}" placeholder="example@mail.com"
                                    class="input-field w-full rounded-xl px-4 py-3 outline-none text-white placeholder-white/40">
                            </div>
                            
                            <button onclick="saveSettings()" class="btn-primary w-full rounded-xl py-3 font-semibold mt-6">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        </div>
                        
                        <div id="settingsMessage" class="mt-4 text-center hidden"></div>
                        
                        <!-- 10 –∫–ª–∏–∫–æ–≤ –¥–ª—è dev –º–µ–Ω—é -->
                        <div class="mt-8 pt-6 border-t border-white/10 text-center">
                            <p onclick="GroupManager.handleDevClick()" class="text-white/30 text-xs cursor-default select-none">MAX soft v1.0</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveSettings() {
            const displayName = document.getElementById('settingsDisplayName').value.trim();
            const email = document.getElementById('settingsEmail').value.trim();
            
            if (!displayName) {
                const msg = document.getElementById('settingsMessage');
                msg.textContent = '–í–≤–µ–¥–∏—Ç–µ –∏–º—è';
                msg.className = 'mt-4 text-center text-red-400';
                msg.classList.remove('hidden');
                return;
            }
            
            try {
                const res = await fetch(window.API_URL + '/api/user/' + window.currentUser.id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ displayName, email })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    window.currentUser = data.user;
                    localStorage.setItem('maxutra_user', JSON.stringify(window.currentUser));
                    
                    const msg = document.getElementById('settingsMessage');
                    msg.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!';
                    msg.className = 'mt-4 text-center text-green-400';
                    msg.classList.remove('hidden');
                    
                    setTimeout(() => {
                        closeModal();
                        renderMainApp();
                    }, 1000);
                }
            } catch (e) {
                console.error('Error:', e);
            }
        }

        async function logout() {
            try {
                await fetch(window.API_URL + '/api/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: window.currentUser.id })
                });
            } catch (e) {}
            
            if (window.ws) {
                window.ws.close();
                window.ws = null;
            }
            localStorage.removeItem('maxutra_user');
            window.currentUser = null;
            window.currentChat = null;
            window.otherUserData = null;
            renderAuth();
        }

        // Helpers
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            }
            
            return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // –ú–æ–±–∏–ª—å–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
        function goBackToChats() {
            window.currentChat = null;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∞–π–¥–±–∞—Ä –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('hidden-mobile');
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞
            document.getElementById('chatArea').innerHTML = `
                <div class="flex-1 flex items-center justify-center text-white/50">
                    <div class="text-center p-8">
                        <div class="w-24 h-24 mx-auto mb-6 rounded-3xl bg-white/5 flex items-center justify-center">
                            <svg class="w-12 h-12 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-white/70 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                        <p class="text-sm">–∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</p>
                    </div>
                </div>
            `;
        }
        
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        function isMobile() {
            return window.innerWidth <= 768;
        }
        
        // –ó–≤—É–∫ —Å–æ–æ–±—â–µ–Ω–∏—è
        let audioContext = null;
        function playMessageSound() {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                console.log('[Sound] –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫:', e);
            }
        }

        // Init
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
