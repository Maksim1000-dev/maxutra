<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maxutra - –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .chat-bubble-sent {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px 20px 5px 20px;
        }
        
        .chat-bubble-received {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px 20px 20px 5px;
        }
        
        .sidebar {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
        }
        
        .chat-area {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
        }
        
        .user-online::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: #10b981;
            border-radius: 50%;
            border: 2px solid #1a1a2e;
        }
        
        .user-offline::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: #6b7280;
            border-radius: 50%;
            border: 2px solid #1a1a2e;
        }
        
        .message-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.5);
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .pulse-call {
            animation: pulseCall 1.5s ease-in-out infinite;
        }
        
        @keyframes pulseCall {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(102, 126, 234, 0); }
        }
        
        .typing-indicator span {
            animation: typing 1.4s infinite;
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            margin: 0 2px;
        }
        
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .input-field {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            background: rgba(255, 255, 255, 0.12);
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        
        .chat-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        
        .chat-item.active {
            background: rgba(102, 126, 234, 0.2);
            border-left: 3px solid #667eea;
        }
        
        .emoji-picker {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            padding: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .emoji-btn {
            font-size: 20px;
            padding: 4px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .emoji-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.2);
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div id="app">
        <div class="min-h-screen flex items-center justify-center">
            <div class="text-center">
                <div class="w-16 h-16 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-white/70">–ó–∞–≥—Ä—É–∑–∫–∞ Maxutra...</p>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–æ–¥—É–ª–∏ -->
    <script src="permissions.js"></script>
    <script src="call.js"></script>
    <script src="group.js"></script>
    
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        window.API_URL = window.location.origin;
        window.currentUser = null;
        window.currentChat = null;
        window.ws = null;
        window.otherUserData = null;
        
        let typingTimeout = null;
        
        // –ë–∞–∑–æ–≤—ã–µ —ç–º–æ–¥–∑–∏
        const basicEmojis = ['üòÄ', 'üòÇ', 'üòç', 'ü•∞', 'üòé', 'ü§î', 'üò¢', 'üò°', 'üëç', 'üëé', '‚ù§Ô∏è', 'üî•', '‚ú®', 'üéâ', 'üëã', 'üôè', 'üí™', 'ü§ù', 'üëÄ', 'üíØ', 'üéµ', 'üì∑', 'üéÆ', 'üíª'];

        // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –∏–∑ localStorage
        function safeGetUser() {
            try {
                const saved = localStorage.getItem('maxutra_user');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (parsed && parsed.id && parsed.username) {
                        return parsed;
                    }
                }
            } catch (e) {
                console.log('–û—á–∏—Å—Ç–∫–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage');
                localStorage.removeItem('maxutra_user');
            }
            return null;
        }

        // Initialize app
        function init() {
            window.currentUser = safeGetUser();
            if (window.currentUser) {
                connectWebSocket();
                renderMainApp();
            } else {
                renderAuth();
            }
        }

        // WebSocket connection
        function connectWebSocket() {
            if (!window.currentUser) return;
            
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            window.ws = new WebSocket(wsProtocol + '//' + window.location.host);
            
            window.ws.onopen = function() {
                console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                window.ws.send(JSON.stringify({ type: 'auth', userId: window.currentUser.id }));
            };
            
            window.ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ WebSocket —Å–æ–æ–±—â–µ–Ω–∏—è:', e);
                }
            };
            
            window.ws.onclose = function() {
                console.log('WebSocket –æ—Ç–∫–ª—é—á–µ–Ω, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
                setTimeout(function() {
                    if (window.currentUser) connectWebSocket();
                }, 3000);
            };
            
            window.ws.onerror = function(e) {
                console.error('WebSocket –æ—à–∏–±–∫–∞:', e);
            };
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'new_message':
                    if (window.currentChat && data.message.chatId === window.currentChat.id) {
                        appendMessage(data.message);
                    }
                    loadChats();
                    break;
                    
                case 'incoming_call':
                    CallManager.showIncomingCall(data);
                    break;
                    
                case 'call_accepted':
                    CallManager.onCallAccepted();
                    break;
                    
                case 'call_ended':
                    CallManager.cleanup();
                    break;
                    
                case 'webrtc_offer':
                    CallManager.handleOffer(data);
                    break;
                    
                case 'webrtc_answer':
                    CallManager.handleAnswer(data);
                    break;
                    
                case 'webrtc_ice':
                    CallManager.handleIceCandidate(data);
                    break;
                    
                case 'user_typing':
                    showTypingIndicator(data);
                    break;
                    
                case 'group_call_invite':
                    // –í—Ö–æ–¥—è—â–∏–π –≥—Ä—É–ø–ø–æ–≤–æ–π –∑–≤–æ–Ω–æ–∫
                    showGroupCallInvite(data);
                    break;
            }
        }
        
        function showGroupCallInvite(data) {
            const html = `
                <div class="fixed inset-0 modal-overlay flex items-center justify-center z-50 fade-in" id="groupCallInviteModal">
                    <div class="bg-gray-800 rounded-3xl p-8 text-center max-w-sm w-full mx-4 shadow-2xl">
                        <div class="w-24 h-24 mx-auto rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-3xl font-bold mb-4 pulse-call">
                            <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold mb-2">–ì—Ä—É–ø–ø–æ–≤–æ–π –∑–≤–æ–Ω–æ–∫</h3>
                        <p class="text-white/50 mb-2">${escapeHtml(data.callerName)} –ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç –≤–∞—Å</p>
                        <p class="text-sm text-white/40 mb-6">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${data.participants ? data.participants.length : 2}</p>
                        <div class="flex justify-center gap-6">
                            <button onclick="rejectGroupCallInvite()" 
                                class="w-16 h-16 rounded-full bg-red-500 hover:bg-red-600 flex items-center justify-center transition shadow-lg shadow-red-500/30">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                            <button onclick="acceptGroupCallInvite()" 
                                class="w-16 h-16 rounded-full bg-green-500 hover:bg-green-600 flex items-center justify-center transition shadow-lg shadow-green-500/30">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modals').innerHTML = html;
            window._pendingGroupCall = data;
        }
        
        function acceptGroupCallInvite() {
            const data = window._pendingGroupCall;
            if (data) {
                GroupManager.startGroupCall(data.groupId, data.participants, data.callType);
            }
            document.getElementById('modals').innerHTML = '';
        }
        
        function rejectGroupCallInvite() {
            document.getElementById('modals').innerHTML = '';
            window._pendingGroupCall = null;
        }

        // Auth screens
        function renderAuth() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen gradient-bg flex items-center justify-center p-4">
                    <div class="glass rounded-3xl p-8 w-full max-w-md fade-in">
                        <div class="text-center mb-8">
                            <div class="w-20 h-20 mx-auto mb-4 rounded-2xl bg-white/20 flex items-center justify-center">
                                <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
                                </svg>
                            </div>
                            <h1 class="text-4xl font-bold mb-2">
                                <span class="bg-clip-text text-transparent bg-gradient-to-r from-white to-purple-200">Maxutra</span>
                            </h1>
                            <p class="text-white/70">–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</p>
                        </div>
                        
                        <div id="authForm">
                            <div id="loginForm">
                                <input type="text" id="loginUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" 
                                    class="input-field w-full rounded-xl px-4 py-3 mb-4 outline-none text-white placeholder-white/50">
                                <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" 
                                    class="input-field w-full rounded-xl px-4 py-3 mb-6 outline-none text-white placeholder-white/50">
                                <button onclick="login()" 
                                    class="btn-primary w-full rounded-xl py-3 font-semibold text-white">
                                    –í–æ–π—Ç–∏
                                </button>
                                <div class="flex justify-between mt-6 text-sm">
                                    <button onclick="showRegister()" class="text-purple-200 hover:text-white transition">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                                    <button onclick="showForgotPassword()" class="text-purple-200 hover:text-white transition">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="errorMessage" class="mt-4 p-3 bg-red-500/20 border border-red-500/50 rounded-xl text-red-300 text-center hidden"></div>
                    </div>
                </div>
            `;
        }

        function showRegister() {
            document.getElementById('authForm').innerHTML = `
                <div id="registerForm" class="fade-in">
                    <input type="text" id="regDisplayName" placeholder="–í–∞—à–µ –∏–º—è (–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –¥—Ä—É–≥–∏–º)" 
                        class="input-field w-full rounded-xl px-4 py-3 mb-4 outline-none text-white placeholder-white/50">
                    <input type="text" id="regUsername" placeholder="–õ–æ–≥–∏–Ω (–¥–ª—è –≤—Ö–æ–¥–∞)" 
                        class="input-field w-full rounded-xl px-4 py-3 mb-4 outline-none text-white placeholder-white/50">
                    <input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å" 
                        class="input-field w-full rounded-xl px-4 py-3 mb-4 outline-none text-white placeholder-white/50">
                    <input type="text" id="regSecretCode" placeholder="–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥ (–¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è)" 
                        class="input-field w-full rounded-xl px-4 py-3 mb-3 outline-none text-white placeholder-white/50">
                    <p class="text-xs text-white/50 mb-6 text-center">–ó–∞–ø–æ–º–Ω–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥ ‚Äî –æ–Ω –Ω—É–∂–µ–Ω –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è</p>
                    <button onclick="register()" 
                        class="btn-primary w-full rounded-xl py-3 font-semibold text-white">
                        –°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç
                    </button>
                    <button onclick="renderAuth()" class="w-full mt-4 py-2 text-purple-200 hover:text-white transition">
                        ‚Üê –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç
                    </button>
                </div>
            `;
        }

        function showForgotPassword() {
            document.getElementById('authForm').innerHTML = `
                <div id="forgotForm" class="fade-in">
                    <h3 class="text-lg font-semibold mb-6 text-center">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</h3>
                    <input type="text" id="forgotUsername" placeholder="–í–∞—à –ª–æ–≥–∏–Ω" 
                        class="input-field w-full rounded-xl px-4 py-3 mb-4 outline-none text-white placeholder-white/50">
                    <input type="text" id="forgotSecretCode" placeholder="–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥" 
                        class="input-field w-full rounded-xl px-4 py-3 mb-4 outline-none text-white placeholder-white/50">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="flex-1 h-px bg-white/20"></div>
                        <span class="text-white/50 text-sm">–∏–ª–∏</span>
                        <div class="flex-1 h-px bg-white/20"></div>
                    </div>
                    <input type="email" id="forgotEmail" placeholder="Email (–µ—Å–ª–∏ —É–∫–∞–∑—ã–≤–∞–ª–∏)" 
                        class="input-field w-full rounded-xl px-4 py-3 mb-6 outline-none text-white placeholder-white/50">
                    <button onclick="forgotPassword()" 
                        class="btn-primary w-full rounded-xl py-3 font-semibold text-white">
                        –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                    </button>
                    <button onclick="renderAuth()" class="w-full mt-4 py-2 text-purple-200 hover:text-white transition">
                        ‚Üê –ù–∞–∑–∞–¥ –∫ –≤—Ö–æ–¥—É
                    </button>
                    <div id="recoveredPassword" class="mt-6 p-4 bg-green-500/20 border border-green-500/50 rounded-xl hidden">
                        <p class="text-green-300 text-center">–í–∞—à –ø–∞—Ä–æ–ª—å: <span id="passwordDisplay" class="font-bold text-white"></span></p>
                    </div>
                </div>
            `;
        }

        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            try {
                const res = await fetch(window.API_URL + '/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: username, password: password })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    window.currentUser = data.user;
                    localStorage.setItem('maxutra_user', JSON.stringify(window.currentUser));
                    connectWebSocket();
                    renderMainApp();
                } else {
                    showError(data.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
                }
            } catch (e) {
                console.error('Login error:', e);
                showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            }
        }

        async function register() {
            const displayName = document.getElementById('regDisplayName').value.trim();
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;
            const secretCode = document.getElementById('regSecretCode').value.trim();
            
            if (!displayName || !username || !password || !secretCode) {
                showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            try {
                const res = await fetch(window.API_URL + '/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username: username, 
                        password: password, 
                        secretCode: secretCode, 
                        displayName: displayName 
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    window.currentUser = data.user;
                    localStorage.setItem('maxutra_user', JSON.stringify(window.currentUser));
                    connectWebSocket();
                    renderMainApp();
                } else {
                    showError(data.error || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
                }
            } catch (e) {
                console.error('Register error:', e);
                showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            }
        }

        async function forgotPassword() {
            const username = document.getElementById('forgotUsername').value.trim();
            const secretCode = document.getElementById('forgotSecretCode').value.trim();
            const email = document.getElementById('forgotEmail').value.trim();
            
            if (!username) {
                showError('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω');
                return;
            }
            
            if (!secretCode && !email) {
                showError('–í–≤–µ–¥–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥ –∏–ª–∏ email');
                return;
            }
            
            try {
                const res = await fetch(window.API_URL + '/api/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: username, secretCode: secretCode, email: email })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    document.getElementById('recoveredPassword').classList.remove('hidden');
                    document.getElementById('passwordDisplay').textContent = data.password;
                } else {
                    showError(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å');
                }
            } catch (e) {
                console.error('Forgot password error:', e);
                showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
                setTimeout(function() { 
                    errorEl.classList.add('hidden'); 
                }, 4000);
            }
        }

        // Main App
        function renderMainApp() {
            const devSettings = GroupManager.getDevSettings();
            
            document.getElementById('app').innerHTML = `
                <div class="flex h-screen">
                    <!-- Sidebar -->
                    <div class="sidebar w-80 flex flex-col border-r border-white/10">
                        <!-- Header -->
                        <div class="p-4 border-b border-white/10">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center font-bold">
                                        ${window.currentUser.displayName ? window.currentUser.displayName.charAt(0).toUpperCase() : 'U'}
                                    </div>
                                    <div>
                                        <h1 class="font-bold text-lg bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-400">Maxutra</h1>
                                        <p class="text-xs text-white/50">${window.currentUser.displayName || window.currentUser.username}</p>
                                    </div>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="GroupManager.showCreateGroupDialog()" class="p-2 hover:bg-white/10 rounded-lg transition" title="–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É">
                                        <svg class="w-5 h-5 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                    </button>
                                    <button onclick="showSettings()" class="p-2 hover:bg-white/10 rounded-lg transition" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                                        <svg class="w-5 h-5 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                    </button>
                                    <button onclick="logout()" class="p-2 hover:bg-white/10 rounded-lg transition" title="–í—ã–π—Ç–∏">
                                        <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Search -->
                            <div class="relative">
                                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π..." 
                                    oninput="searchUsers()"
                                    class="input-field w-full rounded-xl px-4 py-2.5 pl-10 outline-none text-white placeholder-white/50 text-sm">
                                <svg class="w-4 h-4 absolute left-3.5 top-3 text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <div id="searchResults" class="mt-2 max-h-60 overflow-y-auto hidden bg-gray-800/90 rounded-xl"></div>
                        </div>
                        
                        <!-- Chats list -->
                        <div class="flex-1 overflow-y-auto scrollbar-thin" id="chatsList">
                            <div class="p-8 text-center text-white/50">
                                <div class="w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
                                <p>–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chat area -->
                    <div class="flex-1 chat-area flex flex-col" id="chatArea">
                        <div class="flex-1 flex items-center justify-center text-white/50">
                            <div class="text-center p-8">
                                <div class="w-24 h-24 mx-auto mb-6 rounded-3xl bg-white/5 flex items-center justify-center">
                                    <svg class="w-12 h-12 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-xl font-semibold text-white/70 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                                <p class="text-sm">–∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Modals container -->
                <div id="modals"></div>
            `;
            
            loadChats();
        }

        async function loadChats() {
            try {
                const res = await fetch(window.API_URL + '/api/chats/' + window.currentUser.id);
                const chats = await res.json();
                
                const chatsList = document.getElementById('chatsList');
                if (!chatsList) return;
                
                if (chats.length === 0) {
                    chatsList.innerHTML = `
                        <div class="p-8 text-center text-white/50">
                            <svg class="w-16 h-16 mx-auto mb-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                            <p class="font-medium mb-1">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤</p>
                            <p class="text-sm">–ù–∞–π–¥–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫ –≤—ã—à–µ</p>
                        </div>
                    `;
                    return;
                }
                
                chatsList.innerHTML = chats.map(function(chat) {
                    var isActive = window.currentChat && window.currentChat.id === chat.id;
                    var otherUser = chat.otherUser || {};
                    var initial = otherUser.displayName ? otherUser.displayName.charAt(0).toUpperCase() : '?';
                    var statusClass = otherUser.status === 'online' ? 'user-online' : 'user-offline';
                    var lastMsg = chat.lastMessage ? chat.lastMessage.content : '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
                    var lastTime = chat.lastMessage ? formatTime(chat.lastMessage.timestamp) : '';
                    
                    return '<div onclick="openChat(\'' + chat.id + '\', \'' + otherUser.id + '\')" class="chat-item p-4 cursor-pointer transition border-b border-white/5 ' + (isActive ? 'active' : '') + '">' +
                        '<div class="flex items-center gap-3">' +
                            '<div class="relative ' + statusClass + '">' +
                                '<div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-lg font-semibold">' + initial + '</div>' +
                            '</div>' +
                            '<div class="flex-1 min-w-0">' +
                                '<div class="flex justify-between items-center">' +
                                    '<h3 class="font-semibold truncate">' + (otherUser.displayName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π') + '</h3>' +
                                    '<span class="text-xs text-white/30 ml-2">' + lastTime + '</span>' +
                                '</div>' +
                                '<p class="text-sm text-white/50 truncate">' + escapeHtml(lastMsg) + '</p>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                }).join('');
            } catch (e) {
                console.error('Error loading chats:', e);
            }
        }

        async function searchUsers() {
            var query = document.getElementById('searchInput').value.trim();
            var resultsEl = document.getElementById('searchResults');
            
            if (query.length < 2) {
                resultsEl.classList.add('hidden');
                return;
            }
            
            try {
                var res = await fetch(window.API_URL + '/api/users/search?query=' + encodeURIComponent(query) + '&currentUserId=' + window.currentUser.id);
                var users = await res.json();
                
                if (users.length === 0) {
                    resultsEl.innerHTML = '<div class="p-4 text-white/50 text-sm text-center">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                } else {
                    resultsEl.innerHTML = users.map(function(user) {
                        var initial = user.displayName.charAt(0).toUpperCase();
                        var statusClass = user.status === 'online' ? 'user-online' : 'user-offline';
                        return '<div onclick="startChatWith(\'' + user.id + '\')" class="p-3 hover:bg-white/10 cursor-pointer transition flex items-center gap-3">' +
                            '<div class="relative ' + statusClass + '">' +
                                '<div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center font-semibold">' + initial + '</div>' +
                            '</div>' +
                            '<div class="flex-1">' +
                                '<p class="font-medium">' + escapeHtml(user.displayName) + '</p>' +
                                '<p class="text-xs text-white/50">@' + escapeHtml(user.username) + '</p>' +
                            '</div>' +
                        '</div>';
                    }).join('');
                }
                
                resultsEl.classList.remove('hidden');
            } catch (e) {
                console.error('Error searching users:', e);
            }
        }

        async function startChatWith(userId) {
            try {
                var res = await fetch(window.API_URL + '/api/chats', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId1: window.currentUser.id, userId2: userId })
                });
                
                var chat = await res.json();
                document.getElementById('searchInput').value = '';
                document.getElementById('searchResults').classList.add('hidden');
                await loadChats();
                openChat(chat.id, userId);
            } catch (e) {
                console.error('Error starting chat:', e);
            }
        }

        async function openChat(chatId, otherUserId) {
            window.currentChat = { id: chatId, otherUserId: otherUserId };
            
            try {
                // Get other user info
                var usersRes = await fetch(window.API_URL + '/api/users?currentUserId=' + window.currentUser.id);
                var users = await usersRes.json();
                window.otherUserData = users.find(function(u) { return u.id === otherUserId; }) || {};
                
                // Get messages
                var messagesRes = await fetch(window.API_URL + '/api/messages/' + chatId);
                var messages = await messagesRes.json();
                
                var initial = window.otherUserData.displayName ? window.otherUserData.displayName.charAt(0).toUpperCase() : '?';
                var statusClass = window.otherUserData.status === 'online' ? 'user-online' : 'user-offline';
                var statusText = window.otherUserData.status === 'online' ? '–í —Å–µ—Ç–∏' : '–ù–µ –≤ —Å–µ—Ç–∏';
                
                var messagesHtml = messages.length === 0 
                    ? '<div class="text-center text-white/50 mt-10"><p>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!</p><p class="text-sm mt-1">–ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</p></div>'
                    : messages.map(function(m) { return renderMessage(m); }).join('');
                
                var devSettings = GroupManager.getDevSettings();
                var groupCallBtn = devSettings.groupCallsEnabled ? `
                    <button onclick="GroupManager.showGroupCallDialog('${otherUserId}')" class="p-3 hover:bg-white/10 rounded-xl transition" title="–ì—Ä—É–ø–ø–æ–≤–æ–π –∑–≤–æ–Ω–æ–∫">
                        <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </button>
                ` : '';
                
                var emojiBtn = devSettings.emojiEnabled ? `
                    <button onclick="toggleEmojiPicker()" class="p-3 hover:bg-white/10 rounded-xl transition" title="–≠–º–æ–¥–∑–∏" id="emojiToggleBtn">
                        <svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </button>
                ` : '';
                
                document.getElementById('chatArea').innerHTML = `
                    <!-- Chat header -->
                    <div class="p-4 border-b border-white/10 flex items-center justify-between bg-black/20">
                        <div class="flex items-center gap-3">
                            <div class="relative ${statusClass}">
                                <div class="w-11 h-11 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center font-semibold text-lg">${initial}</div>
                            </div>
                            <div>
                                <h3 class="font-semibold">${escapeHtml(window.otherUserData.displayName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π')}</h3>
                                <p class="text-xs text-white/50">${statusText}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            ${groupCallBtn}
                            <button onclick="startCall('audio')" class="p-3 hover:bg-white/10 rounded-xl transition" title="–ê—É–¥–∏–æ–∑–≤–æ–Ω–æ–∫">
                                <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                </svg>
                            </button>
                            <button onclick="startCall('video')" class="p-3 hover:bg-white/10 rounded-xl transition" title="–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫">
                                <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Messages -->
                    <div class="flex-1 overflow-y-auto p-4 scrollbar-thin" id="messagesContainer">
                        ${messagesHtml}
                    </div>
                    
                    <!-- Typing indicator -->
                    <div id="typingIndicator" class="px-4 py-2 hidden">
                        <div class="typing-indicator flex items-center gap-1 text-white/50 text-sm">
                            <span></span><span></span><span></span>
                            <span class="ml-2">${escapeHtml(window.otherUserData.displayName || '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫')} –ø–µ—á–∞—Ç–∞–µ—Ç...</span>
                        </div>
                    </div>
                    
                    <!-- Emoji picker -->
                    <div id="emojiPicker" class="hidden mx-4 mb-2 bg-gray-800 rounded-xl border border-white/10">
                        <div class="emoji-picker">
                            ${basicEmojis.map(e => '<span class="emoji-btn" onclick="insertEmoji(\'' + e + '\')">' + e + '</span>').join('')}
                        </div>
                    </div>
                    
                    <!-- Input -->
                    <div class="p-4 border-t border-white/10 bg-black/20">
                        <div class="flex gap-3 items-center">
                            ${emojiBtn}
                            <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                                onkeydown="handleMessageKeydown(event)"
                                oninput="sendTyping()"
                                class="message-input flex-1 bg-white/10 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-white/50">
                            <button onclick="sendMessage()" 
                                class="btn-primary px-5 py-3 rounded-xl flex items-center justify-center">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                
                scrollToBottom();
                loadChats();
            } catch (e) {
                console.error('Error opening chat:', e);
            }
        }
        
        function toggleEmojiPicker() {
            var picker = document.getElementById('emojiPicker');
            if (picker) {
                picker.classList.toggle('hidden');
            }
        }
        
        function insertEmoji(emoji) {
            var input = document.getElementById('messageInput');
            if (input) {
                input.value += emoji;
                input.focus();
            }
        }

        function renderMessage(message) {
            var isSent = message.senderId === window.currentUser.id;
            var bubbleClass = isSent ? 'chat-bubble-sent' : 'chat-bubble-received';
            var alignClass = isSent ? 'justify-end' : 'justify-start';
            var timeClass = isSent ? 'text-white/60' : 'text-white/40';
            
            return '<div class="flex ' + alignClass + ' mb-3 slide-in">' +
                '<div class="' + bubbleClass + ' px-4 py-2.5 max-w-[70%] shadow-lg">' +
                    '<p class="break-words">' + escapeHtml(message.content) + '</p>' +
                    '<p class="text-xs ' + timeClass + ' mt-1">' + formatTime(message.timestamp) + '</p>' +
                '</div>' +
            '</div>';
        }

        function appendMessage(message) {
            var container = document.getElementById('messagesContainer');
            if (container) {
                var emptyMsg = container.querySelector('.text-center');
                if (emptyMsg) {
                    container.innerHTML = '';
                }
                container.insertAdjacentHTML('beforeend', renderMessage(message));
                scrollToBottom();
            }
        }

        function scrollToBottom() {
            var container = document.getElementById('messagesContainer');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }

        async function sendMessage() {
            var input = document.getElementById('messageInput');
            var content = input.value.trim();
            
            if (!content || !window.currentChat) return;
            
            // –°–∫—Ä—ã–≤–∞–µ–º emoji picker
            var picker = document.getElementById('emojiPicker');
            if (picker) picker.classList.add('hidden');
            
            try {
                await fetch(window.API_URL + '/api/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chatId: window.currentChat.id,
                        senderId: window.currentUser.id,
                        content: content
                    })
                });
                
                input.value = '';
            } catch (e) {
                console.error('Error sending message:', e);
            }
        }

        function handleMessageKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function sendTyping() {
            if (window.ws && window.ws.readyState === 1 && window.currentChat) {
                window.ws.send(JSON.stringify({
                    type: 'typing',
                    chatId: window.currentChat.id,
                    userId: window.currentUser.id
                }));
            }
        }

        function showTypingIndicator(data) {
            if (window.currentChat && data.chatId === window.currentChat.id && data.userId !== window.currentUser.id) {
                var indicator = document.getElementById('typingIndicator');
                if (indicator) {
                    indicator.classList.remove('hidden');
                    clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(function() {
                        indicator.classList.add('hidden');
                    }, 2000);
                }
            }
        }

        // –í—ã–∑–æ–≤—ã —á–µ—Ä–µ–∑ CallManager
        function startCall(type) {
            if (!window.currentChat || !window.otherUserData) return;
            CallManager.startCall(type, window.currentChat.otherUserId, window.otherUserData.displayName || '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫');
        }

        // Settings
        function showSettings() {
            var displayName = window.currentUser.displayName || '';
            var email = window.currentUser.email || '';
            
            document.getElementById('modals').innerHTML = `
                <div class="fixed inset-0 modal-overlay flex items-center justify-center z-50 fade-in">
                    <div class="bg-gray-800 rounded-3xl p-6 max-w-md w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-semibold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h2>
                            <button onclick="closeSettings()" class="p-2 hover:bg-white/10 rounded-lg transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm text-white/70 mb-2">–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è</label>
                                <input type="text" id="settingsDisplayName" value="${escapeHtml(displayName)}"
                                    class="input-field w-full rounded-xl px-4 py-3 outline-none text-white">
                            </div>
                            
                            <div>
                                <label class="block text-sm text-white/70 mb-2">Email (–¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è)</label>
                                <input type="email" id="settingsEmail" value="${escapeHtml(email)}" placeholder="example@mail.com"
                                    class="input-field w-full rounded-xl px-4 py-3 outline-none text-white placeholder-white/40">
                            </div>
                            
                            <button onclick="saveSettings()" 
                                class="btn-primary w-full rounded-xl py-3 font-semibold text-white mt-6">
                                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                            </button>
                        </div>
                        
                        <div id="settingsMessage" class="mt-4 text-center hidden"></div>
                        
                        <!-- MAX soft –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è dev –º–µ–Ω—é -->
                        <div class="mt-8 pt-6 border-t border-white/10 text-center">
                            <p onclick="GroupManager.handleDevClick()" class="text-white/30 text-xs cursor-default select-none">MAX soft v1.0</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveSettings() {
            var displayName = document.getElementById('settingsDisplayName').value.trim();
            var email = document.getElementById('settingsEmail').value.trim();
            
            if (!displayName) {
                var msg = document.getElementById('settingsMessage');
                msg.textContent = '–í–≤–µ–¥–∏—Ç–µ –∏–º—è';
                msg.className = 'mt-4 text-center text-red-400';
                msg.classList.remove('hidden');
                return;
            }
            
            try {
                var res = await fetch(window.API_URL + '/api/user/' + window.currentUser.id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ displayName: displayName, email: email })
                });
                
                var data = await res.json();
                
                if (data.success) {
                    window.currentUser = data.user;
                    localStorage.setItem('maxutra_user', JSON.stringify(window.currentUser));
                    
                    var msg = document.getElementById('settingsMessage');
                    msg.textContent = '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!';
                    msg.className = 'mt-4 text-center text-green-400';
                    msg.classList.remove('hidden');
                    
                    setTimeout(function() {
                        closeSettings();
                        renderMainApp();
                    }, 1000);
                }
            } catch (e) {
                console.error('Error saving settings:', e);
            }
        }

        function closeSettings() {
            document.getElementById('modals').innerHTML = '';
        }

        async function logout() {
            try {
                await fetch(window.API_URL + '/api/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: window.currentUser.id })
                });
            } catch (e) {
                console.error('Error logging out:', e);
            }
            
            if (window.ws) {
                window.ws.close();
                window.ws = null;
            }
            localStorage.removeItem('maxutra_user');
            window.currentUser = null;
            window.currentChat = null;
            window.otherUserData = null;
            renderAuth();
        }

        // Helpers
        function formatTime(timestamp) {
            var date = new Date(timestamp);
            var now = new Date();
            
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            }
            
            return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
        }

        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI —á–∞—Ç–∞ —Å —É—á–µ—Ç–æ–º dev –Ω–∞—Å—Ç—Ä–æ–µ–∫
        function updateChatInputUI() {
            if (window.currentChat && window.otherUserData) {
                openChat(window.currentChat.id, window.currentChat.otherUserId);
            }
        }

        // Initialize app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
