<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maxutra - Мессенджер</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .chat-bubble-sent {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px 20px 5px 20px;
        }
        
        .chat-bubble-received {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px 20px 20px 5px;
        }
        
        .sidebar {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
        }
        
        .chat-area {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
        }
        
        .user-online::before {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: #10b981;
            border-radius: 50%;
            border: 2px solid #1a1a2e;
        }
        
        .user-offline::before {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: #6b7280;
            border-radius: 50%;
            border: 2px solid #1a1a2e;
        }
        
        .message-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.5);
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .pulse-call {
            animation: pulseCall 1.5s ease-in-out infinite;
        }
        
        @keyframes pulseCall {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .typing-indicator span {
            animation: typing 1.4s infinite;
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            margin: 0 2px;
        }
        
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div id="app"></div>

    <script>
        const API_URL = window.location.origin;
        let currentUser = null;
        let currentChat = null;
        let ws = null;
        let peerConnection = null;
        let localStream = null;
        let currentCall = null;

        // Initialize app
        function init() {
            const savedUser = localStorage.getItem('maxutra_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                connectWebSocket();
                renderMainApp();
            } else {
                renderAuth();
            }
        }

        // WebSocket connection
        function connectWebSocket() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${wsProtocol}//${window.location.host}`);
            
            ws.onopen = () => {
                ws.send(JSON.stringify({ type: 'auth', userId: currentUser.id }));
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = () => {
                setTimeout(connectWebSocket, 3000);
            };
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'new_message':
                    if (currentChat && data.message.chatId === currentChat.id) {
                        appendMessage(data.message);
                    }
                    loadChats();
                    break;
                case 'incoming_call':
                    showIncomingCall(data);
                    break;
                case 'call_accepted':
                    startWebRTCConnection(true);
                    break;
                case 'call_ended':
                    endCall();
                    break;
                case 'webrtc_offer':
                    handleWebRTCOffer(data);
                    break;
                case 'webrtc_answer':
                    handleWebRTCAnswer(data);
                    break;
                case 'webrtc_ice':
                    handleICECandidate(data);
                    break;
                case 'user_typing':
                    showTypingIndicator(data);
                    break;
            }
        }

        // Auth screens
        function renderAuth() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen gradient-bg flex items-center justify-center p-4">
                    <div class="glass rounded-3xl p-8 w-full max-w-md slide-in">
                        <div class="text-center mb-8">
                            <h1 class="text-4xl font-bold mb-2">
                                <span class="bg-clip-text text-transparent bg-gradient-to-r from-purple-200 to-pink-200">Maxutra</span>
                            </h1>
                            <p class="text-white/70">Ваш безопасный мессенджер</p>
                        </div>
                        
                        <div id="authForm">
                            <div id="loginForm">
                                <input type="text" id="loginUsername" placeholder="Имя пользователя" 
                                    class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 mb-4 focus:outline-none focus:border-purple-400 transition">
                                <input type="password" id="loginPassword" placeholder="Пароль" 
                                    class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 mb-4 focus:outline-none focus:border-purple-400 transition">
                                <button onclick="login()" 
                                    class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 rounded-xl py-3 font-semibold transition transform hover:scale-[1.02]">
                                    Войти
                                </button>
                                <div class="flex justify-between mt-4 text-sm">
                                    <button onclick="showRegister()" class="text-purple-300 hover:text-white transition">Регистрация</button>
                                    <button onclick="showForgotPassword()" class="text-purple-300 hover:text-white transition">Забыли пароль?</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="errorMessage" class="mt-4 text-red-400 text-center hidden"></div>
                    </div>
                </div>
            `;
        }

        function showRegister() {
            document.getElementById('authForm').innerHTML = `
                <div id="registerForm" class="fade-in">
                    <input type="text" id="regDisplayName" placeholder="Отображаемое имя" 
                        class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 mb-4 focus:outline-none focus:border-purple-400 transition">
                    <input type="text" id="regUsername" placeholder="Имя пользователя (логин)" 
                        class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 mb-4 focus:outline-none focus:border-purple-400 transition">
                    <input type="password" id="regPassword" placeholder="Пароль" 
                        class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 mb-4 focus:outline-none focus:border-purple-400 transition">
                    <input type="text" id="regSecretCode" placeholder="Секретный код (для восстановления)" 
                        class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 mb-4 focus:outline-none focus:border-purple-400 transition">
                    <p class="text-xs text-white/50 mb-4">Секретный код нужен для восстановления пароля</p>
                    <button onclick="register()" 
                        class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 rounded-xl py-3 font-semibold transition transform hover:scale-[1.02]">
                        Зарегистрироваться
                    </button>
                    <button onclick="renderAuth()" class="w-full mt-3 text-purple-300 hover:text-white transition">
                        ← Назад к входу
                    </button>
                </div>
            `;
        }

        function showForgotPassword() {
            document.getElementById('authForm').innerHTML = `
                <div id="forgotForm" class="fade-in">
                    <h3 class="text-lg font-semibold mb-4 text-center">Восстановление пароля</h3>
                    <input type="text" id="forgotUsername" placeholder="Имя пользователя" 
                        class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 mb-4 focus:outline-none focus:border-purple-400 transition">
                    <input type="text" id="forgotSecretCode" placeholder="Секретный код" 
                        class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 mb-4 focus:outline-none focus:border-purple-400 transition">
                    <p class="text-center text-white/50 text-sm mb-2">или</p>
                    <input type="email" id="forgotEmail" placeholder="Email (если был указан)" 
                        class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 mb-4 focus:outline-none focus:border-purple-400 transition">
                    <button onclick="forgotPassword()" 
                        class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 rounded-xl py-3 font-semibold transition transform hover:scale-[1.02]">
                        Восстановить
                    </button>
                    <button onclick="renderAuth()" class="w-full mt-3 text-purple-300 hover:text-white transition">
                        ← Назад к входу
                    </button>
                    <div id="recoveredPassword" class="mt-4 p-4 bg-green-500/20 rounded-xl hidden">
                        <p class="text-green-300">Ваш пароль: <span id="passwordDisplay" class="font-bold"></span></p>
                    </div>
                </div>
            `;
        }

        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const res = await fetch(`${API_URL}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('maxutra_user', JSON.stringify(currentUser));
                    connectWebSocket();
                    renderMainApp();
                } else {
                    showError(data.error);
                }
            } catch (e) {
                showError('Ошибка подключения к серверу');
            }
        }

        async function register() {
            const displayName = document.getElementById('regDisplayName').value;
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const secretCode = document.getElementById('regSecretCode').value;
            
            try {
                const res = await fetch(`${API_URL}/api/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, secretCode, displayName })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('maxutra_user', JSON.stringify(currentUser));
                    connectWebSocket();
                    renderMainApp();
                } else {
                    showError(data.error);
                }
            } catch (e) {
                showError('Ошибка подключения к серверу');
            }
        }

        async function forgotPassword() {
            const username = document.getElementById('forgotUsername').value;
            const secretCode = document.getElementById('forgotSecretCode').value;
            const email = document.getElementById('forgotEmail').value;
            
            try {
                const res = await fetch(`${API_URL}/api/forgot-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, secretCode, email })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    document.getElementById('recoveredPassword').classList.remove('hidden');
                    document.getElementById('passwordDisplay').textContent = data.password;
                } else {
                    showError(data.error);
                }
            } catch (e) {
                showError('Ошибка подключения к серверу');
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
            setTimeout(() => errorEl.classList.add('hidden'), 3000);
        }

        // Main App
        function renderMainApp() {
            document.getElementById('app').innerHTML = `
                <div class="flex h-screen">
                    <!-- Sidebar -->
                    <div class="sidebar w-80 flex flex-col">
                        <!-- Header -->
                        <div class="p-4 border-b border-white/10">
                            <div class="flex items-center justify-between mb-4">
                                <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-400">Maxutra</h1>
                                <div class="flex gap-2">
                                    <button onclick="showSettings()" class="p-2 hover:bg-white/10 rounded-lg transition" title="Настройки">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                    </button>
                                    <button onclick="logout()" class="p-2 hover:bg-white/10 rounded-lg transition text-red-400" title="Выйти">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Search -->
                            <div class="relative">
                                <input type="text" id="searchInput" placeholder="Поиск людей..." 
                                    onkeyup="searchUsers()"
                                    class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2 pl-10 focus:outline-none focus:border-purple-400 transition">
                                <svg class="w-5 h-5 absolute left-3 top-2.5 text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <div id="searchResults" class="mt-2 hidden"></div>
                        </div>
                        
                        <!-- Chats list -->
                        <div class="flex-1 overflow-y-auto scrollbar-thin" id="chatsList">
                            <div class="p-4 text-center text-white/50">Загрузка чатов...</div>
                        </div>
                    </div>
                    
                    <!-- Chat area -->
                    <div class="flex-1 chat-area flex flex-col" id="chatArea">
                        <div class="flex-1 flex items-center justify-center text-white/50">
                            <div class="text-center">
                                <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                </svg>
                                <p>Выберите чат или найдите собеседника</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Modals container -->
                <div id="modals"></div>
            `;
            
            loadChats();
        }

        async function loadChats() {
            try {
                const res = await fetch(`${API_URL}/api/chats/${currentUser.id}`);
                const chats = await res.json();
                
                const chatsList = document.getElementById('chatsList');
                
                if (chats.length === 0) {
                    chatsList.innerHTML = `
                        <div class="p-4 text-center text-white/50">
                            <p>У вас пока нет чатов</p>
                            <p class="text-sm mt-2">Найдите собеседника через поиск</p>
                        </div>
                    `;
                    return;
                }
                
                chatsList.innerHTML = chats.map(chat => `
                    <div onclick="openChat('${chat.id}', '${chat.otherUser?.id}')" 
                        class="p-4 border-b border-white/5 hover:bg-white/5 cursor-pointer transition ${currentChat?.id === chat.id ? 'bg-white/10' : ''}">
                        <div class="flex items-center gap-3">
                            <div class="relative ${chat.otherUser?.status === 'online' ? 'user-online' : 'user-offline'}">
                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-lg font-semibold">
                                    ${chat.otherUser?.displayName?.charAt(0) || '?'}
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="font-semibold truncate">${chat.otherUser?.displayName || 'Неизвестный'}</h3>
                                <p class="text-sm text-white/50 truncate">${chat.lastMessage?.content || 'Нет сообщений'}</p>
                            </div>
                            ${chat.lastMessage ? `<span class="text-xs text-white/30">${formatTime(chat.lastMessage.timestamp)}</span>` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Error loading chats:', e);
            }
        }

        async function searchUsers() {
            const query = document.getElementById('searchInput').value;
            const resultsEl = document.getElementById('searchResults');
            
            if (query.length < 2) {
                resultsEl.classList.add('hidden');
                return;
            }
            
            try {
                const res = await fetch(`${API_URL}/api/users/search?query=${encodeURIComponent(query)}&currentUserId=${currentUser.id}`);
                const users = await res.json();
                
                if (users.length === 0) {
                    resultsEl.innerHTML = '<div class="p-3 text-white/50 text-sm">Пользователи не найдены</div>';
                } else {
                    resultsEl.innerHTML = users.map(user => `
                        <div onclick="startChatWith('${user.id}')" 
                            class="p-3 hover:bg-white/10 cursor-pointer transition rounded-lg flex items-center gap-3">
                            <div class="relative ${user.status === 'online' ? 'user-online' : 'user-offline'}">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center font-semibold">
                                    ${user.displayName.charAt(0)}
                                </div>
                            </div>
                            <div>
                                <p class="font-medium">${user.displayName}</p>
                                <p class="text-xs text-white/50">@${user.username}</p>
                            </div>
                        </div>
                    `).join('');
                }
                
                resultsEl.classList.remove('hidden');
            } catch (e) {
                console.error('Error searching users:', e);
            }
        }

        async function startChatWith(userId) {
            try {
                const res = await fetch(`${API_URL}/api/chats`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId1: currentUser.id, userId2: userId })
                });
                
                const chat = await res.json();
                document.getElementById('searchInput').value = '';
                document.getElementById('searchResults').classList.add('hidden');
                loadChats();
                openChat(chat.id, userId);
            } catch (e) {
                console.error('Error starting chat:', e);
            }
        }

        let otherUserData = null;

        async function openChat(chatId, otherUserId) {
            currentChat = { id: chatId, otherUserId };
            
            // Get other user info
            const usersRes = await fetch(`${API_URL}/api/users?currentUserId=${currentUser.id}`);
            const users = await usersRes.json();
            otherUserData = users.find(u => u.id === otherUserId);
            
            // Get messages
            const messagesRes = await fetch(`${API_URL}/api/messages/${chatId}`);
            const messages = await messagesRes.json();
            
            document.getElementById('chatArea').innerHTML = `
                <!-- Chat header -->
                <div class="p-4 border-b border-white/10 flex items-center justify-between bg-white/5">
                    <div class="flex items-center gap-3">
                        <div class="relative ${otherUserData?.status === 'online' ? 'user-online' : 'user-offline'}">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center font-semibold">
                                ${otherUserData?.displayName?.charAt(0) || '?'}
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold">${otherUserData?.displayName || 'Неизвестный'}</h3>
                            <p class="text-xs text-white/50">${otherUserData?.status === 'online' ? 'В сети' : 'Не в сети'}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="startCall('audio')" class="p-3 hover:bg-white/10 rounded-xl transition" title="Аудиозвонок">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                            </svg>
                        </button>
                        <button onclick="startCall('video')" class="p-3 hover:bg-white/10 rounded-xl transition" title="Видеозвонок">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Messages -->
                <div class="flex-1 overflow-y-auto p-4 scrollbar-thin" id="messagesContainer">
                    ${messages.length === 0 ? 
                        '<div class="text-center text-white/50 mt-10">Начните общение!</div>' :
                        messages.map(m => renderMessage(m)).join('')
                    }
                </div>
                
                <!-- Typing indicator -->
                <div id="typingIndicator" class="px-4 py-2 hidden">
                    <div class="typing-indicator flex items-center gap-1 text-white/50 text-sm">
                        <span></span><span></span><span></span>
                        <span class="ml-2">${otherUserData?.displayName} печатает...</span>
                    </div>
                </div>
                
                <!-- Input -->
                <div class="p-4 border-t border-white/10 bg-white/5">
                    <div class="flex gap-3">
                        <input type="text" id="messageInput" placeholder="Написать сообщение..." 
                            onkeydown="handleMessageKeydown(event)"
                            oninput="sendTyping()"
                            class="message-input flex-1 bg-white/10 border border-white/10 rounded-xl px-4 py-3 transition">
                        <button onclick="sendMessage()" 
                            class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 px-6 rounded-xl transition transform hover:scale-105">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            
            scrollToBottom();
            loadChats();
        }

        function renderMessage(message) {
            const isSent = message.senderId === currentUser.id;
            return `
                <div class="flex ${isSent ? 'justify-end' : 'justify-start'} mb-3 slide-in">
                    <div class="${isSent ? 'chat-bubble-sent' : 'chat-bubble-received'} px-4 py-2 max-w-[70%]">
                        <p>${escapeHtml(message.content)}</p>
                        <p class="text-xs ${isSent ? 'text-white/50' : 'text-white/30'} mt-1">${formatTime(message.timestamp)}</p>
                    </div>
                </div>
            `;
        }

        function appendMessage(message) {
            const container = document.getElementById('messagesContainer');
            if (container) {
                // Remove "start chatting" message if it exists
                if (container.querySelector('.text-center')) {
                    container.innerHTML = '';
                }
                container.insertAdjacentHTML('beforeend', renderMessage(message));
                scrollToBottom();
            }
        }

        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content || !currentChat) return;
            
            try {
                await fetch(`${API_URL}/api/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chatId: currentChat.id,
                        senderId: currentUser.id,
                        content
                    })
                });
                
                input.value = '';
            } catch (e) {
                console.error('Error sending message:', e);
            }
        }

        function handleMessageKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        let typingTimeout;
        function sendTyping() {
            if (ws && currentChat) {
                clearTimeout(typingTimeout);
                ws.send(JSON.stringify({
                    type: 'typing',
                    chatId: currentChat.id,
                    userId: currentUser.id
                }));
            }
        }

        function showTypingIndicator(data) {
            if (currentChat && data.chatId === currentChat.id && data.userId !== currentUser.id) {
                const indicator = document.getElementById('typingIndicator');
                if (indicator) {
                    indicator.classList.remove('hidden');
                    clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(() => {
                        indicator.classList.add('hidden');
                    }, 2000);
                }
            }
        }

        // Calls
        function startCall(type) {
            if (!currentChat || !otherUserData) return;
            
            const callId = Date.now().toString();
            currentCall = { id: callId, type, isInitiator: true };
            
            ws.send(JSON.stringify({
                type: 'call_request',
                callId,
                callerId: currentUser.id,
                receiverId: currentChat.otherUserId,
                callerName: currentUser.displayName,
                callType: type
            }));
            
            showCallUI(type, otherUserData.displayName, true);
        }

        function showIncomingCall(data) {
            currentCall = { id: data.callId, type: data.callType, isInitiator: false, callerId: data.callerId };
            
            document.getElementById('modals').innerHTML = `
                <div class="fixed inset-0 modal-overlay flex items-center justify-center z-50 fade-in">
                    <div class="bg-gray-800 rounded-3xl p-8 text-center max-w-sm w-full mx-4">
                        <div class="w-24 h-24 mx-auto rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-3xl font-bold mb-4 pulse-call">
                            ${data.callerName.charAt(0)}
                        </div>
                        <h3 class="text-xl font-semibold mb-2">${data.callerName}</h3>
                        <p class="text-white/50 mb-6">${data.callType === 'video' ? 'Видеозвонок' : 'Аудиозвонок'}</p>
                        <div class="flex justify-center gap-4">
                            <button onclick="rejectCall()" class="w-16 h-16 rounded-full bg-red-500 hover:bg-red-600 flex items-center justify-center transition">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                            <button onclick="acceptCall()" class="w-16 h-16 rounded-full bg-green-500 hover:bg-green-600 flex items-center justify-center transition">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function acceptCall() {
            ws.send(JSON.stringify({
                type: 'call_accept',
                callId: currentCall.id
            }));
            
            showCallUI(currentCall.type, 'Звонок', false);
            startWebRTCConnection(false);
        }

        function rejectCall() {
            ws.send(JSON.stringify({
                type: 'call_reject',
                callId: currentCall.id
            }));
            
            document.getElementById('modals').innerHTML = '';
            currentCall = null;
        }

        function showCallUI(type, name, isWaiting) {
            document.getElementById('modals').innerHTML = `
                <div class="fixed inset-0 modal-overlay flex items-center justify-center z-50 fade-in">
                    <div class="bg-gray-800 rounded-3xl p-8 text-center max-w-md w-full mx-4">
                        ${type === 'video' ? `
                            <div class="relative mb-4">
                                <video id="remoteVideo" autoplay playsinline class="w-full rounded-2xl bg-gray-900"></video>
                                <video id="localVideo" autoplay playsinline muted class="absolute bottom-4 right-4 w-32 rounded-xl bg-gray-700"></video>
                            </div>
                        ` : `
                            <div class="w-24 h-24 mx-auto rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-3xl font-bold mb-4 ${isWaiting ? 'pulse-call' : ''}">
                                ${name.charAt(0)}
                            </div>
                        `}
                        <h3 class="text-xl font-semibold mb-2">${name}</h3>
                        <p class="text-white/50 mb-6" id="callStatus">${isWaiting ? 'Вызов...' : 'Соединение...'}</p>
                        <p class="text-2xl font-mono mb-6" id="callTimer">00:00</p>
                        <div class="flex justify-center gap-4">
                            <button id="muteBtn" onclick="toggleMute()" class="w-14 h-14 rounded-full bg-gray-700 hover:bg-gray-600 flex items-center justify-center transition">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                                </svg>
                            </button>
                            <button onclick="endCallAction()" class="w-14 h-14 rounded-full bg-red-500 hover:bg-red-600 flex items-center justify-center transition">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        let callStartTime;
        let callTimerInterval;

        async function startWebRTCConnection(isInitiator) {
            try {
                const constraints = {
                    audio: true,
                    video: currentCall.type === 'video'
                };
                
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                if (currentCall.type === 'video') {
                    const localVideo = document.getElementById('localVideo');
                    if (localVideo) localVideo.srcObject = localStream;
                }
                
                peerConnection = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                peerConnection.ontrack = (event) => {
                    const remoteVideo = document.getElementById('remoteVideo');
                    if (remoteVideo && event.streams[0]) {
                        remoteVideo.srcObject = event.streams[0];
                    }
                    
                    // Start call timer
                    document.getElementById('callStatus').textContent = 'На связи';
                    callStartTime = Date.now();
                    callTimerInterval = setInterval(updateCallTimer, 1000);
                };
                
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        ws.send(JSON.stringify({
                            type: 'webrtc_ice',
                            candidate: event.candidate,
                            targetUserId: currentCall.isInitiator ? currentChat.otherUserId : currentCall.callerId
                        }));
                    }
                };
                
                if (isInitiator) {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    ws.send(JSON.stringify({
                        type: 'webrtc_offer',
                        offer,
                        targetUserId: currentChat.otherUserId
                    }));
                }
            } catch (e) {
                console.error('WebRTC error:', e);
                alert('Не удалось получить доступ к камере/микрофону');
                endCall();
            }
        }

        async function handleWebRTCOffer(data) {
            if (peerConnection) {
                await peerConnection.setRemoteDescription(data.offer);
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                ws.send(JSON.stringify({
                    type: 'webrtc_answer',
                    answer,
                    targetUserId: currentCall.callerId
                }));
            }
        }

        async function handleWebRTCAnswer(data) {
            if (peerConnection) {
                await peerConnection.setRemoteDescription(data.answer);
            }
        }

        async function handleICECandidate(data) {
            if (peerConnection && data.candidate) {
                await peerConnection.addIceCandidate(data.candidate);
            }
        }

        function updateCallTimer() {
            const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
            const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const secs = (elapsed % 60).toString().padStart(2, '0');
            const timerEl = document.getElementById('callTimer');
            if (timerEl) timerEl.textContent = `${mins}:${secs}`;
        }

        function toggleMute() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    const btn = document.getElementById('muteBtn');
                    btn.classList.toggle('bg-red-500', !audioTrack.enabled);
                    btn.classList.toggle('bg-gray-700', audioTrack.enabled);
                }
            }
        }

        function endCallAction() {
            if (currentCall) {
                ws.send(JSON.stringify({
                    type: 'call_end',
                    callId: currentCall.id
                }));
            }
            endCall();
        }

        function endCall() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            clearInterval(callTimerInterval);
            document.getElementById('modals').innerHTML = '';
            currentCall = null;
        }

        // Settings
        function showSettings() {
            document.getElementById('modals').innerHTML = `
                <div class="fixed inset-0 modal-overlay flex items-center justify-center z-50 fade-in">
                    <div class="bg-gray-800 rounded-3xl p-6 max-w-md w-full mx-4">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-semibold">Настройки</h2>
                            <button onclick="closeSettings()" class="p-2 hover:bg-white/10 rounded-lg transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm text-white/70 mb-2">Отображаемое имя</label>
                                <input type="text" id="settingsDisplayName" value="${currentUser.displayName || ''}"
                                    class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 focus:outline-none focus:border-purple-400 transition">
                            </div>
                            
                            <div>
                                <label class="block text-sm text-white/70 mb-2">Email (для восстановления пароля)</label>
                                <input type="email" id="settingsEmail" value="${currentUser.email || ''}" placeholder="example@mail.com"
                                    class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 focus:outline-none focus:border-purple-400 transition">
                            </div>
                            
                            <button onclick="saveSettings()" 
                                class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 rounded-xl py-3 font-semibold transition transform hover:scale-[1.02]">
                                Сохранить
                            </button>
                        </div>
                        
                        <div id="settingsMessage" class="mt-4 text-center hidden"></div>
                    </div>
                </div>
            `;
        }

        async function saveSettings() {
            const displayName = document.getElementById('settingsDisplayName').value;
            const email = document.getElementById('settingsEmail').value;
            
            try {
                const res = await fetch(`${API_URL}/api/user/${currentUser.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ displayName, email })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('maxutra_user', JSON.stringify(currentUser));
                    
                    const msg = document.getElementById('settingsMessage');
                    msg.textContent = 'Настройки сохранены!';
                    msg.className = 'mt-4 text-center text-green-400';
                    msg.classList.remove('hidden');
                    
                    setTimeout(closeSettings, 1500);
                }
            } catch (e) {
                console.error('Error saving settings:', e);
            }
        }

        function closeSettings() {
            document.getElementById('modals').innerHTML = '';
        }

        async function logout() {
            try {
                await fetch(`${API_URL}/api/logout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.id })
                });
            } catch (e) {
                console.error('Error logging out:', e);
            }
            
            if (ws) ws.close();
            localStorage.removeItem('maxutra_user');
            currentUser = null;
            currentChat = null;
            renderAuth();
        }

        // Helpers
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            }
            
            return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        init();
    </script>
</body>
</html>
